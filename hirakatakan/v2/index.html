<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>クイズ 日本語 (Quiz Hirakatakan V2)</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">
</head>
<style>
    /* --- Import Font (Google Fonts) --- */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&family=Poppins:wght@400;600&display=swap');

    /* --- Variabel CSS untuk Tema --- */
    :root {
        --light-bg: #f9fafb;
        /* Slightly grayer background */
        --light-text: #1f2937;
        /* Darker text */
        --light-card-bg: #ffffff;
        --light-border: #e5e7eb;
        --light-primary: #111827;
        /* Dark button for primary */
        --light-primary-text: #ffffff;
        --light-secondary-bg: #f3f4f6;
        --light-secondary-text: #374151;
        --light-correct: #16a34a;
        /* Slightly darker green */
        --light-correct-bg: #dcfce7;
        --light-incorrect: #dc2626;
        /* Slightly darker red */
        --light-incorrect-bg: #fee2e2;
        --light-shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
        --light-accent: #ef4444;
        /* Japanese Red accent */

        --dark-bg: #111827;
        /* Dark blue-gray */
        --dark-text: #e5e7eb;
        --dark-card-bg: #1f2937;
        --dark-border: #374151;
        --dark-primary: #f9fafb;
        /* Light button for primary in dark */
        --dark-primary-text: #1f2937;
        --dark-secondary-bg: #374151;
        --dark-secondary-text: #d1d5db;
        --dark-correct: #4ade80;
        --dark-correct-bg: #166534;
        --dark-incorrect: #f87171;
        --dark-incorrect-bg: #991b1b;
        --dark-shadow: 0 1px 3px rgba(255, 255, 255, 0.07), 0 1px 2px rgba(255, 255, 255, 0.04);
        --dark-accent: #f87171;
        /* Lighter red accent */

        --border-radius: 0.5rem;
        --transition-speed: 0.25s;
    }

    /* --- Reset & Base --- */
    *,
    *::before,
    *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html {
        scroll-behavior: smooth;
        /* Enable smooth scrolling */
    }

    body {
        font-family: 'Poppins', 'Noto Sans JP', sans-serif;
        /* Noto Sans JP for Japanese chars */
        transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        min-height: 100vh;
        position: relative;
        /* For background accent */
        overflow-x: hidden;
        /* Prevent horizontal scroll */
        display: flex;
        /* Use flex to push footer down */
        flex-direction: column;
    }

    body.light-theme {
        background-color: var(--light-bg);
        color: var(--light-text);
    }

    body.dark-theme {
        background-color: var(--dark-bg);
        color: var(--dark-text);
    }

    /* --- Background Accent (Subtle Japanese Pattern) --- */
    .background-accent {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e5e7eb' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        opacity: 0.3;
        z-index: -1;
        /* Behind content */
        transition: background-image var(--transition-speed);
    }

    body.dark-theme .background-accent {
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23374151' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }


    /* --- Header & Footer --- */
    header {
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--light-border);
        background-color: var(--light-card-bg);
        /* Header background */
        position: sticky;
        /* Stick to top */
        top: 0;
        z-index: 10;
        /* Above background accent */
        box-shadow: var(--light-shadow);
    }

    body.dark-theme header {
        border-bottom-color: var(--dark-border);
        background-color: var(--dark-card-bg);
        box-shadow: var(--dark-shadow);
    }

    header h1 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 700;
    }

    header h1 .jp-char {
        font-family: 'Noto Sans JP', sans-serif;
        font-weight: 700;
        color: var(--light-accent);
        /* Accent color for JP chars */
        margin: 0 1px;
    }

    body.dark-theme header h1 .jp-char {
        color: var(--dark-accent);
    }

    footer {
        padding: 1.5rem 1rem;
        text-align: center;
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: auto;
        /* Push footer to bottom */
        border-top: 1px solid var(--light-border);
    }

    body.dark-theme footer {
        color: #9ca3af;
        border-top-color: var(--dark-border);
    }

    /* --- Tombol Tema --- */
    .theme-toggle {
        background: none;
        border: 1px solid transparent;
        color: inherit;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        font-size: 1.2rem;
        transition: background-color var(--transition-speed), border-color var(--transition-speed);
        line-height: 1;
    }

    .theme-toggle:hover {
        background-color: var(--light-secondary-bg);
        border-color: var(--light-border);
    }

    body.dark-theme .theme-toggle:hover {
        background-color: var(--dark-secondary-bg);
        border-color: var(--dark-border);
    }

    /* --- Layout Utama & Halaman --- */
    .main-container {
        display: flex;
        flex-direction: column;
        /* Stack pages */
        align-items: center;
        /* Center pages horizontally */
        padding: 2rem 1rem;
        /* Padding around page content */
        width: 100%;
        flex-grow: 1;
        /* Take remaining height */
    }

    .page {
        display: none;
        width: 100%;
        max-width: 700px;
        /* Slightly wider max-width */
        animation: fadeIn 0.5s ease-in-out;
    }

    .page.active {
        display: block;
    }

    /* Wrapper untuk konten di dalam page agar mudah di-style & center */
    .content-wrapper {
        text-align: center;
        padding: 1rem;
        /* Padding inside the wrapper */
        background-color: var(--light-card-bg);
        border-radius: var(--border-radius);
        border: 1px solid var(--light-border);
        box-shadow: var(--light-shadow);
        margin-bottom: 1rem;
        /* Space below wrapper */
    }

    body.dark-theme .content-wrapper {
        background-color: var(--dark-card-bg);
        border-color: var(--dark-border);
        box-shadow: var(--dark-shadow);
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(15px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* --- Tombol Umum (Gaya Shadcn) --- */
    .btn {
        display: inline-flex;
        /* Use flex for icon alignment */
        align-items: center;
        justify-content: center;
        /* Center text/icon */
        gap: 0.5rem;
        /* Space between icon and text */
        padding: 0.7rem 1.4rem;
        font-size: 0.95rem;
        font-weight: 600;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, transform var(--transition-speed) ease;
        margin: 0.4rem;
    }

    .btn i {
        font-size: 1em;
        /* Icon size relative to button text */
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    body.dark-theme .btn:not(:disabled):hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn:active:not(:disabled) {
        transform: translateY(0);
        box-shadow: var(--light-shadow);
        /* Subtle shadow on click */
    }

    body.dark-theme .btn:active:not(:disabled) {
        box-shadow: var(--dark-shadow);
    }

    /* Tombol Primary */
    .light-theme .btn-primary {
        background-color: var(--light-primary);
        color: var(--light-primary-text);
    }

    .light-theme .btn-primary:hover:not(:disabled) {
        background-color: #374151;
    }

    .dark-theme .btn-primary {
        background-color: var(--dark-primary);
        color: var(--dark-primary-text);
    }

    .dark-theme .btn-primary:hover:not(:disabled) {
        background-color: #e5e7eb;
    }

    /* Tombol Secondary */
    .light-theme .btn-secondary {
        background-color: var(--light-secondary-bg);
        color: var(--light-secondary-text);
        border: 1px solid var(--light-border);
    }

    .light-theme .btn-secondary:hover:not(:disabled) {
        background-color: #e5e7eb;
    }

    .dark-theme .btn-secondary {
        background-color: var(--dark-secondary-bg);
        color: var(--dark-secondary-text);
        border: 1px solid var(--dark-border);
    }

    .dark-theme .btn-secondary:hover:not(:disabled) {
        background-color: #4b5563;
    }

    /* Tombol Danger */
    .btn-danger {
        background-color: var(--light-incorrect);
        color: white;
    }

    .dark-theme .btn-danger {
        background-color: var(--dark-incorrect);
        color: var(--dark-primary-text);
    }

    .btn-danger:hover:not(:disabled) {
        opacity: 0.85;
    }

    /* Button Group */
    .button-group {
        margin-top: 1.5rem;
    }

    .button-group.vertical {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .button-group.vertical .btn {
        width: 90%;
        max-width: 350px;
        margin-bottom: 0.75rem;
    }

    .button-group.start-game-group {
        margin-top: 2rem;
        /* Extra space before start game button */
        border-top: 1px solid var(--light-border);
        padding-top: 1.5rem;
    }

    body.dark-theme .button-group.start-game-group {
        border-top-color: var(--dark-border);
    }

    /* --- Home Page --- */
    #home-page .content-wrapper {
        background-color: transparent;
        /* Make wrapper transparent */
        border: none;
        box-shadow: none;
    }

    .home-icon {
        width: 80px;
        height: 80px;
        margin-bottom: 0.5rem;
        border-radius: 50px;
    }

    .tagline {
        font-size: 1.1rem;
        color: #6b7280;
        margin-bottom: 1.5rem;
    }

    body.dark-theme .tagline {
        color: #9ca3af;
    }

    .explanation.card {
        /* Add card style back to explanation */
        text-align: center;
        margin: 1.5rem auto;
        padding: 1.2rem 1.5rem;
        border: 1px solid var(--light-border);
        border-radius: var(--border-radius);
        background-color: var(--light-card-bg);
        box-shadow: var(--light-shadow);
        max-width: 500px;
    }

    body.dark-theme .explanation.card {
        border-color: var(--dark-border);
        background-color: var(--dark-card-bg);
        box-shadow: var(--dark-shadow);
    }

    .explanation h3 {
        margin-top: 0;
        text-align: center;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .explanation p {
        margin-bottom: 0.6rem;
        line-height: 1.6;
        font-size: 0.9rem;
    }

    /* --- Script Selection --- */
    .btn-script {
        font-size: 1.1rem;
        padding: 0.8rem 1.5rem;
    }

    /* --- Category Selection (Accordion Style) --- */
    .selection-hint {
        font-size: 0.9rem;
        color: #6b7280;
        margin-bottom: 1.5rem;
    }

    body.dark-theme .selection-hint {
        color: #9ca3af;
    }

    .category-accordion {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        /* Space between accordion items */
    }

    .main-category-item {
        border: 1px solid var(--light-border);
        border-radius: var(--border-radius);
        background-color: var(--light-card-bg);
        overflow: hidden;
        /* Important for max-height transition */
        transition: background-color var(--transition-speed);
    }

    body.dark-theme .main-category-item {
        border-color: var(--dark-border);
        background-color: var(--dark-card-bg);
    }

    /* Pastikan header tidak menyebabkan scroll aneh */
    .main-category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.8rem 1.2rem;
        cursor: pointer;
        font-weight: 600;
        transition: background-color var(--transition-speed);
        position: relative;
        /* Mencegah z-index aneh jika ada */
        z-index: 1;
        /* Pastikan di atas list */
    }

    .main-category-header:hover {
        background-color: var(--light-secondary-bg);
    }

    body.dark-theme .main-category-header:hover {
        background-color: var(--dark-secondary-bg);
    }

    .main-category-header .toggle-icon {
        transition: transform var(--transition-speed) ease-in-out;
        font-size: 0.8em;
    }

    .main-category-item.active .main-category-header .toggle-icon {
        transform: rotate(180deg);
    }

    /* Sedikit penyesuaian pada transisi subcategory list */
    .subcategory-list {
        max-height: 0;
        /* Hidden by default */
        overflow: hidden;
        transition: max-height 0.35s ease-out, padding 0.35s ease-out, border-top-color 0.35s ease-out;
        /* Sedikit percepat transisi */
        padding: 0 1.2rem;
        /* No padding when hidden */
        border-top: 1px solid transparent;
        /* Separator line, transparent when closed */
    }

    .main-category-item.active .subcategory-list {
        max-height: 1000px;
        /* Set a max-height large enough */
        padding: 1rem 1.2rem;
        border-top-color: var(--light-border);
    }

    body.dark-theme .main-category-item.active .subcategory-list {
        border-top-color: var(--dark-border);
    }


    /* Styling untuk item & label subkategori agar lebih seragam */
    .subcategory-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.8rem; /* Jarak antar checkbox */
        text-align: left;
    }

    /*
    .subcategory-item {
    }
    */

    .subcategory-item label {
        display: flex;
        /* Gunakan flexbox untuk alignment internal */
        align-items: center;
        /* Vertically center checkbox dan teks */
        padding: 0.7rem 0.9rem;
        /* Sesuaikan padding */
        border: 1px solid var(--light-border);
        border-radius: calc(var(--border-radius) / 1.5);
        cursor: pointer;
        transition: background-color var(--transition-speed), border-color var(--transition-speed);
        font-size: 0.9rem;
        min-height: 45px;
        /* Tetapkan tinggi minimum untuk semua label */
        height: 100%;
        /* Coba isi tinggi cell grid */
        box-sizing: border-box;
    }

    body.dark-theme .subcategory-item label {
        border-color: var(--dark-border);
    }

    .subcategory-item label:hover {
        background-color: var(--light-secondary-bg);
        border-color: #d1d5db;
    }

    body.dark-theme .subcategory-item label:hover {
        background-color: var(--dark-secondary-bg);
        border-color: #4b5563;
    }

    .subcategory-item input[type="checkbox"] {
        margin-right: 0.6rem;
        accent-color: var(--light-primary);
        width: 1.1em;
        height: 1.1em;
        flex-shrink: 0;
        /* Prevent checkbox shrinking */
    }

    body.dark-theme .subcategory-item input[type="checkbox"] {
        accent-color: var(--dark-primary);
        filter: invert(1) hue-rotate(180deg);
    }

    .subcategory-item input[type="checkbox"]:checked+span {
        font-weight: 600;
    }

    /* Pastikan teks tidak membuat label terlalu lebar */
    .subcategory-item label span {
        overflow-wrap: break-word;
        /* Atau word-break: break-all; jika perlu */
        word-wrap: break-word;
        /* legacy support */
        line-height: 1.3;
        /* Beri sedikit ruang jika teks wrap */
    }


    /* --- Game Page --- */
    .game-layout {
        display: flex;
        flex-direction: column;
    }

    .game-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        font-weight: 600;
        font-size: 0.9rem;
        color: #6b7280;
    }

    body.dark-theme .game-header {
        color: #9ca3af;
    }

    .question-card {
        background-color: var(--light-card-bg);
        border: 1px solid var(--light-border);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        /* Reduced padding slightly */
        margin-bottom: 1rem;
        /* Reduced margin */
        font-size: 3rem;
        /* Larger size for character */
        font-weight: bold;
        min-height: 120px;
        /* Fixed height */
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: var(--light-shadow);
        font-family: 'Noto Sans JP', sans-serif;
        /* Ensure Japanese font */
    }

    body.dark-theme .question-card {
        background-color: var(--dark-card-bg);
        border-color: var(--dark-border);
        box-shadow: var(--dark-shadow);
    }

    /* Placeholder untuk feedback area to prevent layout shifts */
    .feedback-placeholder {
        min-height: 2.8em;
        /* Naikkan sedikit untuk pesan error yg mungkin 2 baris */
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-bottom: 1rem;
        /* Space before options */
        transition: color var(--transition-speed);
        padding: 0 0.5rem;
        /* Beri padding horizontal jika teks panjang */
        box-sizing: border-box;
    }

    .feedback-placeholder.correct {
        color: var(--light-correct);
    }

    .feedback-placeholder.incorrect {
        color: var(--light-incorrect);
    }

    body.dark-theme .feedback-placeholder.correct {
        color: var(--dark-correct);
    }

    body.dark-theme .feedback-placeholder.incorrect {
        color: var(--dark-incorrect);
    }


    .options-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.8rem;
        /* Reduced gap */
        margin-bottom: 1.5rem;
    }

    .btn-option {
        padding: 0.8rem;
        /* Reduced padding */
        font-size: 1rem;
        border: 1px solid var(--light-border);
        background-color: var(--light-card-bg);
        color: var(--light-text);
        width: 100%;
        box-sizing: border-box;
        justify-content: center;
        /* Center content in button */
        min-height: 50px;
        /* Ensure consistent height */
    }

    body.dark-theme .btn-option {
        border-color: var(--dark-border);
        background-color: var(--dark-card-bg);
        color: var(--dark-text);
    }

    .btn-option:hover:not(:disabled) {
        background-color: var(--light-secondary-bg);
        transform: none;
        box-shadow: none;
    }

    body.dark-theme .btn-option:hover:not(:disabled) {
        background-color: var(--dark-secondary-bg);
    }

    .btn-option.correct {
        background-color: var(--light-correct-bg);
        color: var(--light-correct);
        border-color: var(--light-correct);
        font-weight: bold;
        animation: pulseCorrect 0.6s ease;
    }

    body.dark-theme .btn-option.correct {
        background-color: var(--dark-correct-bg);
        color: var(--dark-correct);
        border-color: var(--dark-correct);
    }

    .btn-option.incorrect {
        background-color: var(--light-incorrect-bg);
        color: var(--light-incorrect);
        border-color: var(--light-incorrect);
        font-weight: bold;
        animation: shakeIncorrect 0.5s ease;
    }

    body.dark-theme .btn-option.incorrect {
        background-color: var(--dark-incorrect-bg);
        color: var(--dark-incorrect);
        border-color: var(--dark-incorrect);
    }

    #confetti-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1000;
    }

    /* Animasi Feedback */
    @keyframes pulseCorrect {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.4);
        }

        50% {
            transform: scale(1.03);
            box-shadow: 0 0 0 10px rgba(22, 163, 74, 0);
        }

        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(22, 163, 74, 0);
        }
    }

    /*
    body.dark-theme @keyframes pulseCorrect {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4);
        }

        50% {
            transform: scale(1.03);
            box-shadow: 0 0 0 10px rgba(74, 222, 128, 0);
        }

        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
        }
    }
    */

    @keyframes shakeIncorrect {

        10%,
        90% {
            transform: translateX(-1px);
        }

        20%,
        80% {
            transform: translateX(2px);
        }

        30%,
        50%,
        70% {
            transform: translateX(-3px);
        }

        40%,
        60% {
            transform: translateX(3px);
        }
    }


    /* --- Result Page --- */
    #result-page h2 .jp-char {
        font-size: 1.5em;
        vertical-align: middle;
    }

    .result-summary.card {
        padding: 1.5rem;
        text-align: left;
    }

    .result-item {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.8rem 0;
        border-bottom: 1px dashed var(--light-border);
        font-size: 1.05rem;
    }

    .result-item:last-child {
        border-bottom: none;
    }

    body.dark-theme .result-item {
        border-bottom-color: var(--dark-border);
    }

    .result-item span {
        flex-grow: 1;
        /* Push value to the right */
    }

    .result-item strong {
        font-weight: 700;
        font-size: 1.1em;
    }

    .result-icon {
        font-size: 1.3em;
        width: 25px;
        /* Fixed width for alignment */
        text-align: center;
        color: #9ca3af;
        /* Default icon color */
    }

    .result-item.correct .result-icon,
    .result-item.correct strong {
        color: var(--light-correct);
    }

    .result-item.incorrect .result-icon,
    .result-item.incorrect strong {
        color: var(--light-incorrect);
    }

    .result-item.percentage .result-icon {
        color: var(--light-primary);
    }

    /* Use primary for percentage */

    body.dark-theme .result-item.correct .result-icon,
    body.dark-theme .result-item.correct strong {
        color: var(--dark-correct);
    }

    body.dark-theme .result-item.incorrect .result-icon,
    body.dark-theme .result-item.incorrect strong {
        color: var(--dark-incorrect);
    }

    body.dark-theme .result-item.percentage .result-icon {
        color: var(--dark-primary);
    }

    /* Progress Bar */
    .progress-bar-container {
        height: 10px;
        background-color: var(--light-secondary-bg);
        border-radius: 5px;
        overflow: hidden;
        margin-top: 1.5rem;
    }

    body.dark-theme .progress-bar-container {
        background-color: var(--dark-secondary-bg);
    }

    .progress-bar {
        height: 100%;
        width: 0;
        /* Will be set by JS */
        background-color: var(--light-correct);
        border-radius: 5px;
        transition: width 0.8s ease-out;
    }

    body.dark-theme .progress-bar {
        background-color: var(--dark-correct);
    }


    /* --- Notifikasi --- */
    .notification {
        position: fixed;
        bottom: -100px;
        /* Start off-screen */
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--light-primary);
        color: var(--light-primary-text);
        padding: 0.8rem 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease, bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        /* Bounce effect */
        font-weight: 500;
        font-size: 0.9rem;
        max-width: 90%;
    }

    body.dark-theme .notification {
        background-color: var(--dark-primary);
        color: var(--dark-primary-text);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .notification.show {
        opacity: 1;
        visibility: visible;
        bottom: 25px;
        /* Position on screen */
    }

    /* --- Responsiveness --- */
    @media (max-width: 768px) {
        header h1 {
            font-size: 1.2rem;
        }

        .main-container {
            padding: 1.5rem 0.8rem;
        }

        .content-wrapper {
            padding: 0.8rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
        }

        .question-card {
            font-size: 2.5rem;
            min-height: 100px;
            padding: 1rem;
        }

        .options-grid {
            gap: 0.6rem;
        }

        .btn-option {
            padding: 0.7rem;
            font-size: 0.9rem;
            min-height: 45px;
        }

        .result-item {
            font-size: 0.95rem;
            gap: 0.6rem;
            padding: 0.6rem 0;
        }

        .result-icon {
            font-size: 1.1em;
        }

        .result-item strong {
            font-size: 1em;
        }

        .button-group.vertical .btn {
            width: 95%;
        }

        .subcategory-options {
            grid-template-columns: repeat(2, 1fr);
        }

        /* Adjust minmax for smaller screens */
    }

    @media (max-width: 480px) {
        header {
            padding: 0.8rem 1rem;
        }

        header h1 {
            font-size: 1.1rem;
        }

        .main-container {
            padding: 1rem 0.5rem;
        }

        .tagline {
            font-size: 1rem;
        }

        .explanation p {
            font-size: 0.85rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .question-card {
            font-size: 2rem;
        }

        .btn-option {
            font-size: 0.85rem;
        }

        .feedback-placeholder {
            min-height: 2.5em;
            font-size: 0.9rem;
        }

        /* Adjust min-height if needed */
        .notification {
            padding: 0.7rem 1.2rem;
            font-size: 0.85rem;
        }

        .subcategory-options {
            grid-template-columns: 1fr;
        }

        /* Stack checkboxes on small screens */
    }
</style>

<body class="light-theme">

    <div class="background-accent"></div>
    <header>
        <h1><span class="jp-char">ク</span><span class="jp-char">イ</span><span class="jp-char">ズ</span> 日本語</h1>
        <button id="theme-toggle-button" class="theme-toggle" aria-label="Toggle theme">
            <i class="fas fa-moon"></i>
        </button>
    </header>

    <main class="main-container">
        <section id="home-page" class="page active">
            <div class="content-wrapper">
                <img src="https://static.vecteezy.com/system/resources/previews/022/041/469/non_2x/torii-gate-icon-style-vector.jpg" alt="Torii Gate Icon" class="home-icon">
                <h2>Selamat Datang!</h2>
                <p class="tagline">Uji pengetahuan Hiragana, Katakana, dan Kanji Anda!</p>
                <div class="explanation card">
                    <h3>Pengenalan Singkat</h3>
                    <p><strong>Hiragana (ひらがな)</strong>
                        <br>Silabari dasar untuk kata-kata asli, partikel, dll.</p>
                    <p><strong>Katakana (カタカナ)</strong> 
                        <br>Untuk kata serapan, onomatopoeia, penekanan.</p>
                    <p><strong>Kanji (漢字)</strong> 
                        <br>Karakter logografis dari Tiongkok.</p>
                </div>
                <div class="button-group">
                    <button id="start-quiz-button" class="btn btn-primary"><i class="fas fa-play"></i> Mulai
                        Quiz</button>
                    <button id="start-learning-button" class="btn btn-secondary"><i class="fas fa-book-open"></i> Sumber
                        Belajar</button>
                </div>
            </div>
        </section>

        <section id="script-selection-page" class="page">
            <div class="content-wrapper">
                <h2><span class="jp-char">①</span> Pilih Skrip</h2>
                <div class="button-group vertical">
                    <button class="btn btn-script" data-script="hiragana">Hiragana (ひらがな)</button>
                    <button class="btn btn-script" data-script="katakana">Katakana (カタカナ)</button>
                    <button class="btn btn-script" data-script="kanji">Kanji (漢字)</button>
                    <button class="btn btn-secondary btn-back" data-target="home-page"><i class="fas fa-arrow-left"></i>
                        Kembali</button>
                </div>
            </div>
        </section>

        <section id="category-selection-page" class="page">
            <div class="content-wrapper">
                <h2><span class="jp-char">②</span> Pilih Kategori <span id="selected-script-title"></span></h2>
                <p class="selection-hint">Klik kategori utama, lalu pilih minimal satu subkategori.</p>
                <div id="main-category-container" class="category-accordion">
                </div>
                <div class="button-group start-game-group">
                    <button id="start-game-button" class="btn btn-primary" disabled><i
                            class="fas fa-flag-checkered"></i> Mulai Game</button>
                    <button type="button" class="btn btn-secondary btn-back" data-target="script-selection-page"><i
                            class="fas fa-arrow-left"></i> Kembali ke Skrip</button>
                </div>
            </div>
        </section>

        <section id="game-page" class="page">
            <div class="content-wrapper game-layout">
                <div class="game-header">
                    <span id="question-counter">Soal 1/10</span>
                    <span id="current-score">Skor: 0</span>
                </div>
                <div id="question-display" class="question-card">
                </div>
                <div id="feedback-area" class="feedback-placeholder">
                </div>
                <div id="options-container" class="options-grid">
                </div>
                <div class="button-group">
                    <button id="quit-game-button" class="btn btn-danger"><i class="fas fa-times-circle"></i>
                        Keluar</button>
                </div>
                <canvas id="confetti-canvas"></canvas>
            </div>
        </section>

        <section id="result-page" class="page">
            <div class="content-wrapper">
                <h2>Hasil Quiz</h2>
                <div class="result-summary card">
                    <div class="result-item">
                        <i class="fas fa-list-ol result-icon"></i>
                        <span>Total Soal:</span>
                        <strong id="result-total">0</strong>
                    </div>
                    <div class="result-item correct">
                        <i class="fas fa-check-circle result-icon"></i>
                        <span>Jawaban Benar:</span>
                        <strong id="result-correct">0</strong>
                    </div>
                    <div class="result-item incorrect">
                        <i class="fas fa-times-circle result-icon"></i>
                        <span>Jawaban Salah:</span>
                        <strong id="result-wrong">0</strong>
                    </div>
                    <div class="result-item percentage">
                        <i class="fas fa-percentage result-icon"></i>
                        <span>Persentase Benar:</span>
                        <strong id="result-percentage">0%</strong>
                    </div>
                    <div class="progress-bar-container">
                        <div id="result-progress-bar" class="progress-bar"></div>
                    </div>
                </div>
                <div class="button-group vertical">
                    <button id="try-again-button" class="btn btn-primary"><i class="fas fa-redo"></i> Coba Lagi (Soal
                        Sama)</button>
                    <button id="new-categories-button" class="btn btn-secondary"><i class="fas fa-layer-group"></i>
                        Pilih Kategori Lain</button>
                    <button id="home-button" class="btn btn-secondary"><i class="fas fa-home"></i> Kembali ke
                        Home</button>
                </div>
            </div>
        </section>
    </main>

    <div id="notification-area" class="notification"></div>

    <footer>
        <p>&copy; 2025 Dibuat dengan <i class="fas fa-heart" style="color: #ef4444;"></i> untuk Pembelajar Bahasa Jepang
        </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- State Aplikasi ---
            let currentScript = null;
            // selectedCategories SEKARANG menyimpan subkategori yg dipilih, cth: "basic:Vowels" atau "n4:Numbers 1-10"
            let selectedSubCategories = [];
            let quizQuestions = []; // Soal untuk ronde saat ini (format: { q, a, options })
            let currentQuestionIndex = 0;
            let score = 0;
            let incorrectAnswers = 0;
            let questionStartTime;
            let currentTheme = localStorage.getItem('theme') || 'light';

            // --- Elemen DOM ---
            const pages = document.querySelectorAll('.page');
            const homePage = document.getElementById('home-page');
            const scriptSelectionPage = document.getElementById('script-selection-page');
            const categorySelectionPage = document.getElementById('category-selection-page');
            const gamePage = document.getElementById('game-page');
            const resultPage = document.getElementById('result-page');
            const startQuizButton = document.getElementById('start-quiz-button');
            const startLearningButton = document.getElementById('start-learning-button');
            const scriptButtons = document.querySelectorAll('.btn-script');
            const mainCategoryContainer = document.getElementById('main-category-container'); // Container baru untuk accordion
            const selectedScriptTitle = document.getElementById('selected-script-title');
            const startGameButton = document.getElementById('start-game-button');
            const backButtons = document.querySelectorAll('.btn-back');
            const questionCounter = document.getElementById('question-counter');
            const currentScoreDisplay = document.getElementById('current-score');
            const questionDisplay = document.getElementById('question-display');
            const optionsContainer = document.getElementById('options-container');
            const feedbackArea = document.getElementById('feedback-area'); // Tetap pakai ID ini
            const quitGameButton = document.getElementById('quit-game-button');
            const resultTotal = document.getElementById('result-total');
            const resultCorrect = document.getElementById('result-correct');
            const resultWrong = document.getElementById('result-wrong');
            const resultPercentage = document.getElementById('result-percentage');
            const resultProgressBar = document.getElementById('result-progress-bar');
            const tryAgainButton = document.getElementById('try-again-button');
            const newCategoriesButton = document.getElementById('new-categories-button');
            const homeButton = document.getElementById('home-button');
            const notificationArea = document.getElementById('notification-area');
            const confettiCanvas = document.getElementById('confetti-canvas');
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const themeIcon = themeToggleButton.querySelector('i');
            
            // --- Data Quiz (Struktur dari iterasi sebelumnya, sudah sesuai) ---
            const quizDataSource = {
                hiragana: {
                    title: 'Hiragana',
                    categories: {
                        basic: {
                            name: 'Basic (Gojūon)', subCategories: {
                                'Vowels': { 'あ': 'a', 'い': 'i', 'う': 'u', 'え': 'e', 'お': 'o' },
                                'K-': { 'か': 'ka', 'き': 'ki', 'く': 'ku', 'け': 'ke', 'こ': 'ko' },
                                'S-': { 'さ': 'sa', 'し': 'shi', 'す': 'su', 'せ': 'se', 'そ': 'so' },
                                'T-': { 'た': 'ta', 'ち': 'chi', 'つ': 'tsu', 'て': 'te', 'と': 'to' },
                                'N-': { 'な': 'na', 'に': 'ni', 'ぬ': 'nu', 'ね': 'ne', 'の': 'no', 'ん': 'n' },
                                'H-': { 'は': 'ha', 'ひ': 'hi', 'ふ': 'fu', 'へ': 'he', 'ほ': 'ho' },
                                'M-': { 'ま': 'ma', 'み': 'mi', 'む': 'mu', 'め': 'me', 'も': 'mo' },
                                'Y-': { 'や': 'ya', 'ゆ': 'yu', 'よ': 'yo' },
                                'R-': { 'ら': 'ra', 'り': 'ri', 'る': 'ru', 'れ': 're', 'ろ': 'ro' },
                                'W-': { 'わ': 'wa', 'を': 'o' }
                            }
                        },

                        dakuten: {
                            name: 'Dakuten/Handakuten', subCategories: {
                                'G-': { 'が': 'ga', 'ぎ': 'gi', 'ぐ': 'gu', 'げ': 'ge', 'ご': 'go' },
                                'Z-': { 'ざ': 'za', 'じ': 'ji', 'ず': 'zu', 'ぜ': 'ze', 'ぞ': 'zo' },
                                'D-': { 'だ': 'da', 'ぢ': 'ji', 'づ': 'zu', 'で': 'de', 'ど': 'do' },
                                'B-': { 'ば': 'ba', 'び': 'bi', 'ぶ': 'bu', 'べ': 'be', 'ぼ': 'bo' },
                                'P-': { 'ぱ': 'pa', 'ぴ': 'pi', 'ぷ': 'pu', 'ぺ': 'pe', 'ぽ': 'po' }
                            }
                        },
                        yoon: {
                            name: 'Yōon (Kombinasi)', subCategories: {
                                'K-': { 'きゃ': 'kya', 'きゅ': 'kyu', 'きょ': 'kyo' },
                                'S-': { 'しゃ': 'sha', 'しゅ': 'shu', 'しょ': 'sho' },
                                'T-': { 'ちゃ': 'cha', 'ちゅ': 'chu', 'ちょ': 'cho' },
                                'N-': { 'にゃ': 'nya', 'にゅ': 'nyu', 'にょ': 'nyo' },
                                'H-': { 'ひゃ': 'hya', 'ひゅ': 'hyu', 'ひょ': 'hyo' },
                                'M-': { 'みゃ': 'mya', 'みゅ': 'myu', 'みょ': 'myo' },
                                'R-': { 'りゃ': 'rya', 'りゅ': 'ryu', 'りょ': 'ryo' },
                                'G-': { 'ぎゃ': 'gya', 'ぎゅ': 'gyu', 'ぎょ': 'gyo' },
                                'J-': { 'じゃ': 'ja', 'じゅ': 'ju', 'じょ': 'jo' },
                                'B-': { 'びゃ': 'bya', 'びゅ': 'byu', 'びょ': 'byo' },
                                'P-': { 'ぴゃ': 'pya', 'ぴゅ': 'pyu', 'ぴょ': 'pyo' }
                            }
                        },
                        particles: {
                            name: 'Particles', subCategories: {
                                'Partikel Dasar': { 'は': 'wa (penanda topik)', 'が': 'ga (penanda subjek)', 'を': 'o (penanda objek langsung)', 'に': 'ni (tujuan, waktu, penerima)', 'で': 'de (tempat, sarana)', 'へ': 'e (arah)', 'と': 'to (dengan, dan)', 'も': 'mo (juga)', 'の': 'no (kepemilikan)', 'から': 'kara (dari)', 'まで': 'made (sampai)', 'や': 'ya (dan, dll)', 'か': 'ka (atau / tanya)', 'ね': 'ne (konfirmasi)', 'よ': 'yo (penegasan)', 'な': 'na (larangan / informal)', }, 'Partikel Kuantitas & Batasan': { 'だけ': 'dake (hanya)', 'しか': 'shika (hanya - negatif)', 'ばかり': 'bakari (hanya, sekitar)', 'ほど': 'hodo (sejauh, sebanding)', 'くらい': 'kurai (sekitar)', 'ぐらい': 'gurai (sekitar)', 'など': 'nado (dan lain-lain)', 'やら': 'yara (seperti, dll)', },
                                'Partikel Perbandingan & Pemilihan': { 'より': 'yori (dibanding)', 'のほうが': 'no hou ga (lebih)', 'のに': 'noni (padahal)', 'でも': 'demo (meskipun, pun)', 'とか': 'toka (seperti, dll)', },
                                'Partikel Kondisional': { 'たら': 'tara (kalau sudah)', 'ば': 'ba (jika)', 'なら': 'nara (jika)', 'ても': 'temo (meskipun)', 'のに': 'noni (walaupun)', 'ながら': 'nagara (sambil)', },
                                'Partikel Penjelas Sebab/Akibat': { 'から': 'kara (karena)', 'ので': 'node (karena)', 'のに': 'noni (padahal)', 'くせに': 'kuseni (padahal - negatif)', },
                                'Partikel Arah & Tujuan': { 'に': 'ni (tujuan, arah)', 'へ': 'e (arah)', 'まで': 'made (hingga)', 'から': 'kara (dari)' },
                                'Partikel Kompleks & Gabungan': { 'として': 'toshite (sebagai)', 'にとって': 'ni totte (bagi)', 'について': 'ni tsuite (tentang)', 'に対して': 'ni taishite (terhadap)', 'によって': 'ni yotte (oleh, tergantung)', 'によると': 'ni yoru to (menurut)', 'に関して': 'ni kanshite (terkait)', 'を通じて': 'wo tsuujite (melalui)', 'を通して': 'wo tooshite (melalui)', 'において': 'ni oite (di, pada)', 'をめぐって': 'wo megutte (seputar)', 'に比べて': 'ni kurabete (dibanding)', }
                            }
                        }
                    }
                },
                katakana: {
                    title: 'Katakana',
                    categories: {
                        basic: { name: 'Basic (Gojūon)', subCategories: { 'Vowels': { 'ア': 'a', 'イ': 'i', 'ウ': 'u', 'エ': 'e', 'オ': 'o' }, 
                                                                          'K-': { 'カ': 'ka', 'キ': 'ki', 'ク': 'ku', 'ケ': 'ke', 'コ': 'ko' }, 
                                                                          'S-': { 'サ': 'sa', 'シ': 'shi', 'ス': 'su', 'セ': 'se', 'ソ': 'so' }, 
                                                                          'T-': { 'タ': 'ta', 'チ': 'chi', 'ツ': 'tsu', 'テ': 'te', 'ト': 'to' }, 
                                                                          'N-': { 'ナ': 'na', 'ニ': 'ni', 'ヌ': 'nu', 'ネ': 'ne', 'ノ': 'no', 'ン': 'n' }, 
                                                                          'H-': { 'ハ': 'ha', 'ヒ': 'hi', 'フ': 'fu', 'ヘ': 'he', 'ホ': 'ho' }, 
                                                                          'M-': { 'マ': 'ma', 'ミ': 'mi', 'ム': 'mu', 'メ': 'me', 'モ': 'mo' }, 
                                                                          'Y-': { 'ヤ': 'ya', 'ユ': 'yu', 'ヨ': 'yo' }, 
                                                                          'R-': { 'ラ': 'ra', 'リ': 'ri', 'ル': 'ru', 'レ': 're', 'ロ': 'ro' }, 
                                                                          'W-': { 'ワ': 'wa', 'ヲ': 'o' } } },
                        dakuten: { name: 'Dakuten/Handakuten', subCategories: { 'G-': { 'ガ': 'ga', 'ギ': 'gi', 'グ': 'gu', 'ゲ': 'ge', 'ゴ': 'go' }, 
                                                                                'Z-': { 'ザ': 'za', 'ジ': 'ji', 'ズ': 'zu', 'ゼ': 'ze', 'ゾ': 'zo' }, 
                                                                                'D-': { 'ダ': 'da', 'ヂ': 'ji', 'ヅ': 'zu', 'デ': 'de', 'ド': 'do' }, 
                                                                                'B-': { 'バ': 'ba', 'ビ': 'bi', 'ブ': 'bu', 'ベ': 'be', 'ボ': 'bo' }, 
                                                                                'P-': { 'パ': 'pa', 'ピ': 'pi', 'プ': 'pu', 'ペ': 'pe', 'ポ': 'po' } } },
                        yoon: { name: 'Yōon (Kombinasi)', subCategories: { 'K-': { 'キャ': 'kya', 'キュ': 'kyu', 'キョ': 'kyo' }, 
                                                                           'S-': { 'シャ': 'sha', 'シュ': 'shu', 'ショ': 'sho' }, 
                                                                           'T-': { 'チャ': 'cha', 'チュ': 'chu', 'チョ': 'cho' }, 
                                                                           'N-': { 'ニャ': 'nya', 'ニュ': 'nyu', 'ニョ': 'nyo' }, 
                                                                           'H-': { 'ヒャ': 'hya', 'ヒュ': 'hyu', 'ヒョ': 'hyo' }, 
                                                                           'M-': { 'ミャ': 'mya', 'ミュ': 'myu', 'ミョ': 'myo' }, 
                                                                           'R-': { 'リャ': 'rya', 'リュ': 'ryu', 'リョ': 'ryo' }, 
                                                                           'G-': { 'ギャ': 'gya', 'ギュ': 'gyu', 'ギョ': 'gyo' }, 
                                                                           'J-': { 'ジャ': 'ja', 'ジュ': 'ju', 'ジョ': 'jo' }, 
                                                                           'B-': { 'ビャ': 'bya', 'ビュ': 'byu', 'ビョ': 'byo' }, 
                                                                           'P-': { 'ピャ': 'pya', 'ピュ': 'pyu', 'ピョ': 'pyo' } } },
                        extended: { name: 'Extended Katakana', subCategories: { 'All': { 'ヴ': 'vu', 'ウィ': 'wi', 'ウェ': 'we', 'ウォ': 'wo', 'シェ': 'she', 'ジェ': 'je', 'チェ': 'che', 'ティ': 'ti', 'ディ': 'di', 'トゥ': 'tu', 'ドゥ': 'du', 'ファ': 'fa', 'フィ': 'fi', 'フェ': 'fe', 'フォ': 'fo' } } }
                    }
                },
                kanji: {
                    title: 'Kanji',
                    categories: {
                    n5 = {name: 'JLPT N5 Level',subCategories: {'Numbers': { '一': 'ichi (1)', '二': 'ni (2)', '三': 'san (3)', '四': 'shi/yon (4)', '五': 'go (5)', '六': 'roku (6)', '七': 'shichi/nana (7)', '八': 'hachi (8)', '九': 'kyuu (9)', '十': 'juu (10)', '百': 'hyaku (100)', '千': 'sen (1,000)', '万': 'man (10,000)', '円': 'en (Yen)' },
                                                                   'Time & Calendar': { '日': 'nichi (day/sun)', '月': 'getsu (month/moon)', '年': 'nen (year)', '時': 'ji (time/hour)', '分': 'fun (minute)', '間': 'kan (interval)', '今': 'ima (now)', '午': 'go (noon)', '前': 'mae (before)', '後': 'ato (after)', '曜': 'you (day of week)' },
                                                                   'People & Family': { '人': 'hito (person)', '男': 'otoko (man)', '女': 'onna (woman)', '子': 'ko (child)', '父': 'chichi (father)', '母': 'haha (mother)', '友': 'tomo (friend)', '名': 'na (name)', '先': 'saki (previous)', '生': 'sei (life)', '兄': 'ani (older brother)', '弟': 'otouto (younger brother)', '姉': 'ane (older sister)', '妹': 'imouto (younger sister)' },
                                                                   'Places & Directions': { '山': 'yama (mountain)', '川': 'kawa (river)', '田': 'ta (rice field)', '町': 'machi (town)', '村': 'mura (village)', '校': 'kou (school)', '国': 'kuni (country)', '家': 'ie (house)', '上': 'ue (up)', '下': 'shita (down)', '左': 'hidari (left)', '右': 'migi (right)', '東': 'higashi (east)', '西': 'nishi (west)', '南': 'minami (south)', '北': 'kita (north)', '外': 'soto (outside)', '中': 'naka (inside)', '駅': 'eki (station)', '道': 'michi (road)' },
                                                                   'Common Verbs': { '行': 'iku (go)', '来': 'kuru (come)', '見': 'miru (see)', '聞': 'kiku (hear)', '話': 'hanasu (speak)', '食': 'taberu (eat)', '飲': 'nomu (drink)', '書': 'kaku (write)', '読': 'yomu (read)', '出': 'deru (exit)', '入': 'hairu (enter)', '立': 'tatsu (stand)', '休': 'yasumu (rest)', '買': 'kau (buy)', '売': 'uru (sell)', '使': 'tsukau (use)', '作': 'tsukuru (make)', '開': 'aku (open)', '閉': 'shimaru (close)', '始': 'hajimeru (start)', '終': 'owaru (end)', '待': 'matsu (wait)', '帰': 'kaeru (return)' },
                                                                   'Adjectives': { '大': 'dai (big)', '小': 'shou (small)', '高': 'takai (tall/expensive)', '安': 'yasui (cheap)', '新': 'atarashii (new)', '古': 'furui (old)', '長': 'nagai (long)', '短': 'mijikai (short)', '多': 'ooi (many)', '少': 'sukunai (few)', '楽': 'tanoshii (fun)', '好': 'suki (like)', '思': 'omou (think)', '知': 'shiru (know)' },
                                                                   'Nature & Weather': { '天': 'ten (heaven)', '気': 'ki (spirit)', '雨': 'ame (rain)', '雪': 'yuki (snow)', '風': 'kaze (wind)', '空': 'sora (sky)', '火': 'hi (fire)', '水': 'mizu (water)', '木': 'ki (tree)', '土': 'tsuchi (earth)' },
                                                                   'Colors': { '白': 'shiro (white)', '黒': 'kuro (black)', '赤': 'aka (red)', '青': 'ao (blue)', '色': 'iro (color)' },
                                                                   'Transportation & Directions': { '車': 'kuruma (car)', '電': 'den (electricity)', '駅': 'eki (station)', '道': 'michi (road)', '線': 'sen (line)', '上': 'ue (up)', '下': 'shita (down)', '左': 'hidari (left)', '右': 'migi (right)', '前': 'mae (front)', '後': 'ushiro (back)' },
                                                                   'Daily Activities': { '起': 'okiru (wake up)', '寝': 'neru (sleep)', '働': 'hataraku (work)', '休': 'yasumu (rest)', '洗': 'arau (wash)', '浴': 'abiru (bathe)', '遊': 'asobu (play)', '走': 'hashiru (run)' },
                                                                   'Food & Drink': { '米': 'kome (rice)', '肉': 'niku (meat)', '魚': 'sakana (fish)', '飲': 'nomu (drink)', '茶': 'cha (tea)', '飯': 'meshi (meal)', '酒': 'sake (alcohol)' },
                                                                   'Work & Education': { '仕': 'shi (work)', '事': 'koto (thing)', '働': 'hataraku (to work)', '学': 'gaku (study)', '校': 'kou (school)', '教': 'kyou (teach)','文': 'bun (sentence)', '書': 'kaku (write)', '読': 'yomu (read)', '聞': 'kiku (listen)', '試': 'tamesu (test)', '験': 'ken (examination)', '社': 'sha (company)', '会': 'kai (meeting)', '員': 'in (member)', '医': 'i (doctor)', '院': 'in (institution)', '生': 'sei (life/student)', '先': 'sen (previous)', '語': 'go (language)', '英': 'ei (English)', '数': 'suu (number)', '理': 'ri (reason)', '科': 'ka (subject)', '計': 'kei (plan)', '算': 'san (calculate)', '答': 'tou (answer)', '問': 'mon (question)', '習': 'shuu (learn)', '業': 'gyou (business)', '研': 'ken (research)', '究': 'kyuu (study)'}
                                                               },
                        n4: { name: 'JLPT N4 Level', subCategories: { 'Time & Calendar': { '日': 'nichi (day)', '月': 'getsu (month)', '年': 'nen (year)', '時': 'ji (time)', '分': 'fun (minute)', '秒': 'byou (second)', '週': 'shuu (week)', '曜': 'you (day of week)', '朝': 'asa (morning)', '昼': 'hiru (noon)', '夜': 'yoru (night)', '季': 'ki (season)' }, 
                                                                      'Numbers 1-10': { '一': 'ichi (1)', '二': 'ni (2)', '三': 'san (3)', '四': 'yon (4)', '五': 'go (5)', '六': 'roku (6)', '七': 'nana (7)', '八': 'hachi (8)', '九': 'kyuu (9)', '十': 'juu (10)' }, 
                                                                      'Numbers & Amounts': { '百': 'hyaku (100)', '千': 'sen (1,000)', '万': 'man (10,000)', '円': 'en (Yen)', '零': 'rei (zero)', '半': 'han (half)' }, 
                                                                      'People & Family': { '人': 'hito (person)', '男': 'otoko (man)', '女': 'onna (woman)', '父': 'chichi (father)', '母': 'haha (mother)', '子': 'ko (child)', '兄': 'ani (older brother)', '弟': 'otouto (younger brother)', '姉': 'ane (older sister)', '妹': 'imouto (younger sister)', '夫': 'otto (husband)', '妻': 'tsuma (wife)' }, 
                                                                      'Places': { '山': 'yama (mountain)', '川': 'kawa (river)', '田': 'ta (rice field)', '町': 'machi (town)', '店': 'mise (shop)', '駅': 'eki (station)', '国': 'kuni (country)', '家': 'ie (house)', '村': 'mura (village)', '市': 'shi (city)' }, 
                                                                      'Common Verbs': { '行': 'iku (go)', '来': 'kuru (come)', '食': 'taberu (eat)', '飲': 'nomu (drink)', '見': 'miru (see)', '聞': 'kiku (hear)', '話': 'hanasu (speak)', '読': 'yomu (read)', '書': 'kaku (write)', '立': 'tatsu (stand)', '帰': 'kaeru (return)', '買': 'kau (buy)' }, 
                                                                      'Adjectives': { '大': 'dai (big)', '小': 'shou (small)', '新': 'shin (new)', '古': 'ko (old)', '高': 'kou (high/expensive)', '安': 'an (cheap)', '早': 'sou (fast/early)', '多': 'ta (many)', '長': 'nagai (long)', '短': 'mijikai (short)' }, 
                                                                      'Nature & Weather': { '木': 'moku (tree)', '林': 'rin (grove)', '森': 'mori (forest)', '火': 'ka (fire)', '水': 'sui (water)', '雨': 'ame (rain)', '風': 'kaze (wind)', '雪': 'yuki (snow)', '天': 'ten (sky)', '気': 'ki (energy)', '土': 'tsuchi (earth)', '霧': 'kiri (fog)', '雷': 'kaminari (thunder)' }, 
                                                                      'Colors': { '赤': 'aka (red)', '青': 'ao (blue)', '白': 'shiro (white)', '黒': 'kuro (black)', '色': 'iro (color)', '灰': 'hai (gray)' }, 
                                                                      'Transportation': { '車': 'kuruma (car)', '電': 'den (electricity)', '道': 'michi (road)', '空': 'sora (sky)', '港': 'minato (harbor)', '北': 'kita (north)', '南': 'minami (south)', '東': 'higashi (east)', '西': 'nishi (west)', '線': 'sen (line)' }, 
                                                                      'Daily Activities': { '寝': 'neru (sleep)', '起': 'okiru (wake up)', '働': 'hataraku (work)', '休': 'yasumu (rest)', '洗': 'arau (wash)', '浴': 'abiru (bathe)', '遊': 'asobu (play)', '走': 'hashiru (run)' }, 
                                                                      'Food & Drink': { '米': 'kome (rice)', '肉': 'niku (meat)', '魚': 'sakana (fish)', '飲': 'nomu (drink)', '茶': 'cha (tea)', '飯': 'meshi (meal)', '酒': 'sake (alcohol)' }, 
                                                                      'Work & Education': { '仕': 'shi (work)', '学': 'gaku (study)', '校': 'kou (school)', '教': 'kyou (teach)', '医': 'i (doctor)', '院': 'in (institution)', '業': 'gyou (business)', '試': 'tamesu (test)', '社': 'sha (company)', '術': 'jutsu (technique)' }, 
                                                                      'Emotions': { '楽': 'tanoshii (happy)', '悲': 'kanashii (sad)', '喜': 'yorokobu (joy)', '怒': 'okoru (anger)', '哀': 'ai (sorrow)', '驚': 'odoroku (surprise)' }, 
                                                                      'Other Important Verbs': { '会': 'au (meet)', '思': 'omou (think)', '使': 'tsukau (use)', '待': 'matsu (wait)', '送': 'okuru (send)', '出': 'deru (exit)', '入': 'hairu (enter)', '開': 'aku (open)', '選': 'eru (choose)' } } }
                        // Tambah N5, N3 etc. di sini
                    }
                }
            };

            // --- Fungsi Navigasi Halaman ---
            function showPage(pageId) {
                pages.forEach(page => page.classList.remove('active'));
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                    window.scrollTo(0, 0); // Scroll ke atas saat pindah halaman
                } else {
                    console.error(`Page with id ${pageId} not found.`);
                    homePage.classList.add('active');
                }
            }

            // --- Fungsi Notifikasi ---
            let notificationTimeout;
            function showNotification(message, duration = 3000) {
                clearTimeout(notificationTimeout);
                notificationArea.textContent = message;
                notificationArea.classList.add('show');
                notificationTimeout = setTimeout(() => {
                    notificationArea.classList.remove('show');
                }, duration);
            }

            // --- Fungsi Tema ---
            function applyTheme(theme) {
                document.body.classList.remove('light-theme', 'dark-theme');
                document.body.classList.add(`${theme}-theme`);
                themeIcon.className = `fas ${theme === 'dark' ? 'fa-sun' : 'fa-moon'}`;
                localStorage.setItem('theme', theme);
                currentTheme = theme;
            }
            function toggleTheme() {
                applyTheme(currentTheme === 'light' ? 'dark' : 'light');
            }
            applyTheme(currentTheme);


            // --- Fungsi Memuat Kategori (Accordion/Dropdown Style) ---
            function loadCategories(script) {
                const scriptData = quizDataSource[script];
                if (!scriptData || !scriptData.categories) {
                    showNotification("Data kategori tidak ditemukan.");
                    return;
                }

                currentScript = script;
                selectedScriptTitle.textContent = `(${scriptData.title})`;
                mainCategoryContainer.innerHTML = ''; // Kosongkan accordion
                selectedSubCategories = []; // Reset pilihan subkategori

                // Buat setiap item accordion untuk kategori utama
                for (const mainCategoryKey in scriptData.categories) {
                    const mainCategory = scriptData.categories[mainCategoryKey];
                    if (mainCategory && mainCategory.name && mainCategory.subCategories) {

                        const mainCategoryItem = document.createElement('div');
                        mainCategoryItem.classList.add('main-category-item');
                        mainCategoryItem.dataset.mainKey = mainCategoryKey; // Simpan key

                        // Header Accordion (bisa diklik)
                        const header = document.createElement('div');
                        header.classList.add('main-category-header');
                        header.innerHTML = `
                    <span>${mainCategory.name}</span>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                `;
                        header.addEventListener('click', () => {
                            mainCategoryItem.classList.toggle('active');
                        });

                        // Kontainer untuk subkategori (tersembunyi)
                        const subListContainer = document.createElement('div');
                        subListContainer.classList.add('subcategory-list');

                        const subOptionsGrid = document.createElement('div');
                        subOptionsGrid.classList.add('subcategory-options');

                        // Buat checkbox untuk setiap subkategori
                        for (const subCategoryKey in mainCategory.subCategories) {
                            const subCategoryItem = document.createElement('div');
                            subCategoryItem.classList.add('subcategory-item');
                            const checkboxId = `subcat-${mainCategoryKey}-${subCategoryKey.replace(/\s+/g, '-')}`; // ID unik
                            // Value format: "mainKey:subKey"
                            const checkboxValue = `${mainCategoryKey}:${subCategoryKey}`;

                            subCategoryItem.innerHTML = `
                        <label for="${checkboxId}">
                            <input type="checkbox" id="${checkboxId}" name="subcategory" value="${checkboxValue}">
                            <span>${subCategoryKey}</span>
                        </label>
                    `;
                            subOptionsGrid.appendChild(subCategoryItem);
                        }

                        subListContainer.appendChild(subOptionsGrid);
                        mainCategoryItem.appendChild(header);
                        mainCategoryItem.appendChild(subListContainer);
                        mainCategoryContainer.appendChild(mainCategoryItem);
                    }
                }
                startGameButton.disabled = true; // Nonaktifkan tombol start awal
                showPage('category-selection-page');
            }

            // --- Fungsi Helper untuk Mengambil Opsi Salah --- (Sama)
            function getDistractors(correctAnswer, answerPool, count = 3) {
                const distractors = new Set();
                const uniqueAnswers = Array.from(new Set(answerPool.filter(ans => ans !== correctAnswer)));
                if (uniqueAnswers.length < count) {
                    while (uniqueAnswers.length < count) uniqueAnswers.push(`Opsi ${uniqueAnswers.length + 1}`);
                }
                while (distractors.size < count && uniqueAnswers.length > 0) {
                    const randomIndex = Math.floor(Math.random() * uniqueAnswers.length);
                    distractors.add(uniqueAnswers.splice(randomIndex, 1)[0]);
                }
                return Array.from(distractors);
            }

            // --- Fungsi Mengumpulkan Soal (Berdasarkan Subkategori) ---
            function prepareQuizQuestions() {
                quizQuestions = [];
                const rawQuestions = [];
                let allPossibleAnswers = [];
                const scriptData = quizDataSource[currentScript];
                if (!scriptData || !scriptData.categories) return;

                selectedSubCategories.forEach(subCategoryValue => {
                    // Value format: "mainKey:subKey"
                    const [mainCategoryKey, subCategoryKey] = subCategoryValue.split(':');

                    if (scriptData.categories[mainCategoryKey] &&
                        scriptData.categories[mainCategoryKey].subCategories &&
                        scriptData.categories[mainCategoryKey].subCategories[subCategoryKey]) {
                        const subCategoryData = scriptData.categories[mainCategoryKey].subCategories[subCategoryKey];
                        for (const questionItem in subCategoryData) {
                            const answerItem = subCategoryData[questionItem];
                            rawQuestions.push({ q: questionItem, a: answerItem });
                            allPossibleAnswers.push(answerItem);
                        }
                    } else {
                        console.warn(`Subcategory data not found for: ${subCategoryValue}`);
                    }
                });

                // Buat soal final dengan opsi
                rawQuestions.forEach(item => {
                    const correctAnswer = item.a;
                    const distractors = getDistractors(correctAnswer, allPossibleAnswers, 3);
                    const options = [correctAnswer, ...distractors];
                    quizQuestions.push({ q: item.q, a: correctAnswer, options: options });
                });

                // Acak soal
                for (let i = quizQuestions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [quizQuestions[i], quizQuestions[j]] = [quizQuestions[j], quizQuestions[i]];
                }
                // Batasi Jumlah Soal (Opsional)
                // quizQuestions = quizQuestions.slice(0, 20);
            }

            // --- Fungsi Menampilkan Soal --- (Sama)
            function displayQuestion() {
                if (currentQuestionIndex >= quizQuestions.length) {
                    showResults();
                    return;
                }
                const questionData = quizQuestions[currentQuestionIndex];
                questionDisplay.textContent = questionData.q;
                optionsContainer.innerHTML = '';
                feedbackArea.textContent = ''; // Kosongkan text, tapi elemen tetap ada
                feedbackArea.className = 'feedback-placeholder'; // Reset kelas

                const options = [...questionData.options];
                options.sort(() => Math.random() - 0.5); // Acak opsi

                options.forEach(option => {
                    const button = document.createElement('button');
                    button.classList.add('btn', 'btn-option');
                    button.textContent = option;
                    button.dataset.answer = option;
                    button.addEventListener('click', handleAnswer);
                    optionsContainer.appendChild(button);
                });

                questionCounter.textContent = `Soal ${currentQuestionIndex + 1}/${quizQuestions.length}`;
                currentScoreDisplay.textContent = `Skor: ${score}`;
                questionStartTime = Date.now();
            }

            // --- Fungsi Menangani Jawaban --- (Sama)
            function handleAnswer(event) {
                const selectedButton = event.target;
                const selectedAnswer = selectedButton.dataset.answer;
                const correctAnswer = quizQuestions[currentQuestionIndex].a;
                const optionButtons = optionsContainer.querySelectorAll('.btn-option');

                optionButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.removeEventListener('click', handleAnswer);
                });

                if (selectedAnswer === correctAnswer) {
                    score++;
                    selectedButton.classList.add('correct');
                    feedbackArea.textContent = 'Benar!';
                    feedbackArea.classList.add('correct');
                    triggerConfetti();
                } else {
                    incorrectAnswers++;
                    selectedButton.classList.add('incorrect');
                    feedbackArea.textContent = `Salah! Jawaban: ${correctAnswer}`; // Tampilkan jawaban benar
                    feedbackArea.classList.add('incorrect');
                    optionButtons.forEach(btn => {
                        if (btn.dataset.answer === correctAnswer) {
                            btn.classList.add('correct'); // Highlight jawaban yg benar
                        }
                    });
                }
                currentScoreDisplay.textContent = `Skor: ${score}`;
                setTimeout(() => {
                    currentQuestionIndex++;
                    displayQuestion();
                }, 1800); // Beri waktu lebih lama sedikit untuk melihat jawaban benar
            }

            // --- Fungsi Menampilkan Hasil --- (Update progress bar)
            function showResults() {
                const totalQuestions = quizQuestions.length;
                resultTotal.textContent = totalQuestions;
                resultCorrect.textContent = score;
                resultWrong.textContent = incorrectAnswers;
                const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
                resultPercentage.textContent = `${percentage}%`;

                // Update progress bar
                resultProgressBar.style.width = `${percentage}%`;

                showPage('result-page');
            }

            // --- Fungsi Mulai Game --- (Check selectedSubCategories)
            function startGame(useSameQuestions = false) {
                score = 0;
                incorrectAnswers = 0;
                currentQuestionIndex = 0;

                if (!useSameQuestions) {
                    prepareQuizQuestions();
                }

                if (quizQuestions.length === 0) {
                    // Ini bisa terjadi jika user deselect semua subkategori setelah memilihnya
                    showNotification("Pilih minimal satu subkategori untuk memulai.");
                    // Jangan pindah halaman, biarkan user memilih lagi
                    // showPage('category-selection-page');
                    return;
                }

                displayQuestion();
                showPage('game-page');
            }

            // --- Fungsi Confetti --- (Sama)
            let confettiInstance = null;
            if (confettiCanvas) {
                confettiInstance = confetti.create(confettiCanvas, { resize: true, useWorker: true });
            }
            function triggerConfetti() {
                if (confettiInstance) {
                    confettiInstance({ particleCount: 120, spread: 80, origin: { y: 0.6 } });
                }
            }

            // --- Event Listeners ---

            themeToggleButton.addEventListener('click', toggleTheme);
            startQuizButton.addEventListener('click', () => showPage('script-selection-page'));
            startLearningButton.addEventListener('click', () => {
                window.open('https://www.tofugu.com/learn-japanese/', '_blank'); // Link lebih umum
                showNotification("Membuka sumber belajar eksternal...");
            });
            scriptButtons.forEach(button => {
                button.addEventListener('click', () => loadCategories(button.dataset.script));
            });
            backButtons.forEach(button => {
                button.addEventListener('click', () => showPage(button.dataset.target));
            });

            // Listener untuk perubahan checkbox subkategori (Event Delegation)
            mainCategoryContainer.addEventListener('change', (event) => {
                if (event.target.type === 'checkbox' && event.target.name === 'subcategory') {
                    // Update selectedSubCategories array
                    selectedSubCategories = Array.from(mainCategoryContainer.querySelectorAll('input[name="subcategory"]:checked'))
                        .map(cb => cb.value);
                    // Enable/disable start button
                    startGameButton.disabled = selectedSubCategories.length === 0;
                }
            });

            // Tombol Start Game (cek selectedSubCategories)
            startGameButton.addEventListener('click', (event) => {
                event.preventDefault();
                if (selectedSubCategories.length > 0) {
                    startGame(false);
                } else {
                    showNotification("Pilih minimal satu subkategori dari dropdown.");
                }
            });

            quitGameButton.addEventListener('click', () => {
                showPage('home-page');
                // Reset state mungkin diperlukan jika ingin pilihan kategori hilang
                currentScript = null;
                selectedSubCategories = [];
                quizQuestions = [];
            });

            tryAgainButton.addEventListener('click', () => startGame(true));
            newCategoriesButton.addEventListener('click', () => {
                if (currentScript) {
                    loadCategories(currentScript); // Kembali ke pemilihan kategori untuk script yg sama
                } else {
                    showPage('script-selection-page');
                }
            });
            homeButton.addEventListener('click', () => {
                showPage('home-page');
                currentScript = null;
                selectedSubCategories = [];
                quizQuestions = [];
            });

            // --- Inisialisasi Awal ---
            showPage('home-page');

        }); // Akhir dari DOMContentLoaded
    </script>
</body>

</html>
