<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WagerNet - Pro Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['Space Mono', 'monospace'], },
                    colors: { bg: '#0B1120', card: '#151F32', accent: '#10B981', danger: '#EF4444', muted: '#64748B' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0B1120; color: #E2E8F0; }
        .input-dark { background: #0F172A; border: 1px solid #334155; color: #E2E8F0; }
        .input-dark:focus { border-color: #10B981; outline: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Tab Styles */
        .tab-btn.active { border-bottom: 2px solid #10B981; color: #10B981; }
        .tab-btn { color: #64748B; transition: all 0.2s; }

        /* SweetAlert Theme Override */
        div:where(.swal2-container) div:where(.swal2-popup) {
            background: #151F32 !important; border: 1px solid #334155; color: #E2E8F0; border-radius: 1rem;
        }

        /* Chat Styles */
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        /* Status Dots */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .online { background-color: #10B981; box-shadow: 0 0 5px #10B981; }
        .offline { background-color: #64748B; }
    </style>
</head>

<body class="min-h-screen pb-20 relative overflow-x-hidden font-sans">

    <div id="authOverlay" class="fixed inset-0 z-[100] bg-[#0B1120] flex flex-col items-center justify-center p-6 hidden">
        <div class="text-center mb-10">
            <div class="w-20 h-20 bg-accent/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-accent/50 shadow-[0_0_20px_rgba(16,185,129,0.3)]">
                <i class="fas fa-network-wired text-3xl text-accent"></i>
            </div>
            <h1 class="text-3xl font-bold tracking-tight text-white">WAGER<span class="text-accent">NET</span></h1>
            <p class="text-muted text-sm font-mono mt-2">Social Contract Protocol</p>
        </div>
        <button onclick="loginWithGoogle()" class="flex items-center gap-3 bg-white text-black px-6 py-3 rounded-xl font-bold hover:bg-gray-200 transition-all">
            <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6"> Sign in with Google
        </button>
    </div>

    <div id="usernameModal" class="fixed inset-0 z-[90] bg-[#0B1120]/95 backdrop-blur flex items-center justify-center p-6 hidden">
        <div class="bg-card p-6 rounded-xl border border-accent w-full max-w-md shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-2">Identify Yourself</h2>
            <input type="text" id="newUsernameInput" placeholder="username" class="w-full input-dark rounded px-4 py-3 font-mono mb-4 lowercase">
            <button onclick="saveUsername()" class="w-full bg-accent text-bg font-bold py-3 rounded">INITIALIZE IDENTITY</button>
        </div>
    </div>

    <nav class="border-b border-slate-800 bg-bg/90 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-2xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-accent animate-pulse"></div>
                <h1 class="font-bold text-sm tracking-widest hidden sm:block">WAGER<span class="text-accent">NET</span></h1>
            </div>
            <div class="flex items-center gap-3" id="navProfile"></div>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto px-4 mt-4">
        <div class="flex border-b border-slate-800">
            <button onclick="switchTab('home')" id="tab-home" class="tab-btn active flex-1 py-3 text-xs sm:text-sm font-bold flex justify-center items-center gap-2">
                <i class="fas fa-home"></i> DASHBOARD
            </button>
            <button onclick="switchTab('chat')" id="tab-chat" class="tab-btn flex-1 py-3 text-xs sm:text-sm font-bold flex justify-center items-center gap-2">
                <i class="fas fa-comment-dots"></i> CHAT
            </button>
            <button onclick="switchTab('network')" id="tab-network" class="tab-btn flex-1 py-3 text-xs sm:text-sm font-bold flex justify-center items-center gap-2 relative">
                <i class="fas fa-users"></i> NETWORK
                <span id="reqBadge" class="hidden w-2 h-2 bg-red-500 rounded-full absolute top-3 right-[20%] animate-ping"></span>
            </button>
        </div>
    </div>

    <div class="max-w-2xl mx-auto px-4 mt-6">

        <div id="view-home" class="fade-in">
            <div class="bg-card rounded-xl border border-slate-700 shadow-xl overflow-hidden mb-8">
                <div class="p-3 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
                    <h2 class="font-mono text-xs text-accent">NEW CONTRACT</h2>
                    <div class="flex bg-slate-900 rounded p-1 border border-slate-800">
                        <button id="btnDirect" class="px-3 py-1 text-[10px] font-bold rounded bg-slate-700 text-white" onclick="toggleType('direct')">DIRECT</button>
                        <button id="btnChoice" class="px-3 py-1 text-[10px] font-bold rounded text-muted" onclick="toggleType('choice')">CHOICE</button>
                    </div>
                </div>

                <form id="wagerForm" onsubmit="submitWager(event)" class="p-5">
                    <div class="mb-4">
                        <label class="text-[10px] text-muted font-mono block mb-1">OPPONENT</label>
                        <select id="targetUserSelect" class="w-full input-dark rounded-lg px-4 py-3 text-sm font-bold bg-slate-900" required>
                            <option value="" disabled selected>Select friend...</option>
                        </select>
                    </div>
                    <div class="mb-4"><input type="text" id="title" placeholder="Context (e.g. FIFA)" class="w-full input-dark rounded-lg px-4 py-3 text-sm font-bold" required></div>
                    <div id="inputDirect" class="mb-4"><textarea id="directRequest" rows="2" placeholder="Input Demand..." class="w-full input-dark rounded-lg px-4 py-3 text-sm font-mono"></textarea></div>
                    <div id="inputChoice" class="mb-4 hidden"><textarea id="choiceOptions" rows="2" placeholder="Option A, Option B" class="w-full input-dark rounded-lg px-4 py-3 text-sm font-mono"></textarea></div>
                    <button type="submit" class="w-full bg-accent hover:bg-emerald-400 text-bg font-bold py-3 rounded-lg text-sm uppercase tracking-widest shadow-[0_0_15px_rgba(16,185,129,0.4)] transition-all">Initiate Protocol</button>
                </form>
            </div>
            <h3 class="text-xs font-mono text-muted mb-4 px-1">ACTIVE CONTRACTS</h3>
            <div id="wagerList" class="space-y-4"></div>
        </div>

        <div id="view-chat" class="hidden fade-in h-[70vh] flex overflow-hidden rounded-xl border border-slate-700 bg-card">
            
            <div id="chatSidebar" class="w-full md:w-1/3 bg-slate-900 border-r border-slate-800 flex flex-col">
                <div class="p-3 border-b border-slate-800 font-bold text-xs text-muted uppercase tracking-wider">Messages</div>
                <div id="chatFriendList" class="overflow-y-auto flex-1 p-2 space-y-1"></div>
            </div>

            <div id="chatRoom" class="w-full md:w-2/3 flex flex-col hidden md:flex bg-[#0B1120]">
                <div class="p-3 border-b border-slate-800 flex items-center gap-3 bg-slate-900">
                    <button onclick="backToChatList()" class="md:hidden text-slate-400"><i class="fas fa-arrow-left"></i></button>
                    <img id="chatHeaderImg" src="" class="w-8 h-8 rounded-full hidden">
                    <div>
                        <div id="chatHeaderName" class="font-bold text-white text-sm">Select a friend</div>
                        <div id="chatHeaderStatus" class="text-[10px] text-muted font-mono"></div>
                    </div>
                </div>
                <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-3 chat-scroll">
                    <div class="text-center text-muted text-xs mt-10">Select a friend to start chatting</div>
                </div>
                <form onsubmit="sendMessage(event)" class="p-3 border-t border-slate-800 bg-slate-900 flex gap-2">
                    <input type="text" id="messageInput" class="flex-1 input-dark rounded-full px-4 py-2 text-sm" placeholder="Type a message..." disabled>
                    <button type="submit" id="sendBtn" class="bg-accent text-bg w-10 h-10 rounded-full font-bold flex items-center justify-center disabled:opacity-50" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <div id="view-network" class="hidden fade-in">
            <div id="pendingSection" class="mb-6 hidden">
                <h3 class="text-xs font-mono text-accent mb-3 uppercase tracking-wider">‚ö° Requests</h3>
                <div id="requestListDisplay" class="space-y-2"></div>
            </div>
            <div class="bg-card p-4 rounded-xl border border-slate-700 mb-8">
                <div class="text-[10px] text-muted font-mono uppercase mb-2">Add Connection</div>
                <div class="flex gap-2">
                    <input type="text" id="friendInput" placeholder="Enter username..." class="flex-1 input-dark rounded px-3 py-2 text-sm font-mono lowercase">
                    <button onclick="sendFriendRequest()" class="bg-slate-700 hover:bg-accent hover:text-bg text-white px-4 rounded text-xs font-bold">ADD</button>
                </div>
            </div>
            <h3 class="text-xs font-mono text-muted mb-3 px-1">FRIENDS</h3>
            <div id="myFriendList" class="space-y-2"></div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, updateDoc, doc, deleteDoc, getDocs, setDoc, getDoc, arrayUnion, writeBatch, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDTLkvNNwh4LoJuLW1JhsF1S_ZOY1k-PAM",
            authDomain: "webchoice-9b2c0.firebaseapp.com",
            projectId: "webchoice-9b2c0",
            storageBucket: "webchoice-9b2c0.firebasestorage.app",
            messagingSenderId: "754013239435",
            appId: "1:754013239435:web:496f9a5851d0586ee43c8e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const usersRef = collection(db, "users");
        const wagersRef = collection(db, "wagers");
        
        let currentUser = null;
        let userProfile = null;
        let currentType = 'direct';
        let currentChatPartner = null;
        let messagesUnsubscribe = null;

        // --- HELPER SWEETALERT ---
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, 
            background: '#151F32', color: '#fff', iconColor: '#10B981',
            didOpen: (toast) => { toast.onmouseenter = Swal.stopTimer; toast.onmouseleave = Swal.resumeTimer; }
        });

        const ConfirmModal = Swal.mixin({
            background: '#151F32', color: '#E2E8F0', confirmButtonColor: '#10B981', cancelButtonColor: '#334155',
            iconColor: '#10B981', showCancelButton: true, confirmButtonText: 'Yes', cancelButtonText: 'No'
        });

        // --- PRESENCE (ONLINE STATUS) ---
        const updateStatus = (status) => {
            if(!currentUser) return;
            const data = { status: status };
            if (status === 'offline') data.lastSeen = serverTimestamp();
            updateDoc(doc(db, "users", currentUser.uid), data);
        };
        document.addEventListener('visibilitychange', () => updateStatus(document.visibilityState === 'visible' ? 'online' : 'offline'));

        // --- AUTH ---
        window.loginWithGoogle = () => signInWithPopup(auth, provider).catch(e => Swal.fire('Error', e.message, 'error'));
        window.logout = () => { updateStatus('offline'); signOut(auth).then(() => location.reload()); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authOverlay').classList.add('hidden');
                updateStatus('online');
                
                onSnapshot(doc(db, "users", user.uid), (snap) => {
                    if (snap.exists()) {
                        userProfile = snap.data();
                        renderNavbar();
                        loadFriendsDropdown();
                        renderFriendListNetwork();
                        renderChatSidebar();
                    } else document.getElementById('usernameModal').classList.remove('hidden');
                });

                listenToWagers();
                listenToFriendRequests();
            } else document.getElementById('authOverlay').classList.remove('hidden');
        });

        // --- CHAT LOGIC ---
        function renderChatSidebar() {
            const list = document.getElementById('chatFriendList');
            list.innerHTML = "";
            if(!userProfile.friends || userProfile.friends.length === 0) {
                list.innerHTML = `<div class="text-[10px] text-center text-muted mt-5">Add friends to chat.</div>`;
                return;
            }
            userProfile.friends.forEach(f => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 cursor-pointer transition-colors";
                div.onclick = () => openChat(f);
                div.innerHTML = `
                    <div class="relative"><img src="${f.photoURL}" class="w-10 h-10 rounded-full border border-slate-700">
                        <span id="dot-${f.uid}" class="status-dot offline absolute bottom-0 right-0 border-2 border-slate-900"></span></div>
                    <div class="flex-1 min-w-0"><div class="text-sm font-bold text-white truncate">@${f.username}</div>
                        <div id="txt-${f.uid}" class="text-[10px] text-muted truncate">Loading...</div></div>`;
                list.appendChild(div);

                onSnapshot(doc(db, "users", f.uid), (s) => {
                    if(s.exists()) {
                        const d = s.data();
                        const dot = document.getElementById(`dot-${f.uid}`);
                        const txt = document.getElementById(`txt-${f.uid}`);
                        if(dot && txt) {
                            const isOnline = d.status === 'online';
                            dot.className = `status-dot absolute bottom-0 right-0 border-2 border-slate-900 ${isOnline ? 'online' : 'offline'}`;
                            txt.innerText = isOnline ? 'Online' : (d.lastSeen ? moment(d.lastSeen.toDate()).fromNow() : 'Offline');
                            txt.classList.toggle('text-accent', isOnline);
                            if(currentChatPartner?.uid === f.uid) updateChatHeader(d);
                        }
                    }
                });
            });
        }

        window.openChat = (f) => {
            currentChatPartner = f;
            document.getElementById('chatSidebar').classList.add('hidden', 'md:flex');
            document.getElementById('chatRoom').classList.remove('hidden');
            document.getElementById('chatHeaderImg').src = f.photoURL;
            document.getElementById('chatHeaderImg').classList.remove('hidden');
            document.getElementById('chatHeaderName').innerText = '@' + f.username;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            loadMessages(f.uid);
        };

        window.backToChatList = () => {
            document.getElementById('chatSidebar').classList.remove('hidden');
            document.getElementById('chatRoom').classList.add('hidden');
            if(messagesUnsubscribe) messagesUnsubscribe();
            currentChatPartner = null;
        };

        function updateChatHeader(d) {
            document.getElementById('chatHeaderStatus').innerHTML = d.status === 'online' 
                ? '<span class="text-accent">‚óè Online</span>' 
                : `Last seen: ${d.lastSeen ? moment(d.lastSeen.toDate()).format('HH:mm') : 'Offline'}`;
        }

        function loadMessages(uid) {
            if(messagesUnsubscribe) messagesUnsubscribe();
            const chatId = [currentUser.uid, uid].sort().join('_');
            messagesUnsubscribe = onSnapshot(query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc"), limit(50)), (snap) => {
                const con = document.getElementById('messagesContainer');
                con.innerHTML = "";
                if(snap.empty) con.innerHTML = `<div class="text-center text-muted text-xs mt-10">Say hi! üëã</div>`;
                snap.forEach(d => {
                    const m = d.data();
                    const me = m.senderId === currentUser.uid;
                    con.innerHTML += `<div class="flex ${me ? 'justify-end' : 'justify-start'}"><div class="max-w-[75%] px-3 py-2 rounded-xl text-sm ${me ? 'bg-accent text-bg rounded-br-none' : 'bg-slate-700 text-white rounded-bl-none'}"><div>${m.text}</div><div class="text-[9px] text-right mt-1 opacity-70">${m.timestamp ? moment(m.timestamp.toDate()).format('HH:mm') : '...'}</div></div></div>`;
                });
                con.scrollTop = con.scrollHeight;
            });
        }

        window.sendMessage = async (e) => {
            e.preventDefault();
            const inp = document.getElementById('messageInput');
            const txt = inp.value.trim();
            if(!txt || !currentChatPartner) return;
            inp.value = "";
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            await addDoc(collection(db, "chats", chatId, "messages"), { text: txt, senderId: currentUser.uid, timestamp: serverTimestamp() });
        };

        // --- WAGER LOGIC ---
        window.submitWager = async (e) => {
            e.preventDefault();
            const targetUid = document.getElementById('targetUserSelect').value;
            if(!targetUid) return Toast.fire({icon: 'error', title: 'Select a friend'});
            
            const friend = userProfile.friends.find(f => f.uid === targetUid);
            let data = {
                title: document.getElementById('title').value, type: currentType, creatorUid: currentUser.uid,
                creatorUsername: userProfile.username, targetUid, targetUsername: friend.username,
                timestamp: new Date(), status: 'pending'
            };

            if (currentType === 'direct') {
                data.content = document.getElementById('directRequest').value;
                if (!data.content) return Toast.fire({icon: 'error', title: 'Demand empty'});
            } else {
                const opts = document.getElementById('choiceOptions').value;
                if (!opts) return Toast.fire({icon: 'error', title: 'Options required'});
                data.options = opts.split(',').map(o => o.trim()).filter(Boolean);
                data.selectedOption = null;
            }

            await addDoc(wagersRef, data);
            document.getElementById('wagerForm').reset();
            Toast.fire({icon: 'success', title: 'Contract Deployed'});
        };

        function listenToWagers() {
            onSnapshot(query(wagersRef, orderBy("timestamp", "desc")), (snap) => {
                const list = document.getElementById('wagerList');
                list.innerHTML = "";
                let hasData = false;

                snap.forEach(docSnap => {
                    const w = docSnap.data();
                    const id = docSnap.id;
                    const isCreator = w.creatorUid === currentUser.uid;
                    const isTarget = w.targetUid === currentUser.uid;

                    if (!isCreator && !isTarget) return;
                    hasData = true;

                    let content = "";
                    if (w.type === 'direct') {
                        content = `<div class="text-lg font-bold text-white mt-2">"${w.content}"</div>`;
                    } else {
                        if (w.selectedOption) {
                            content = `<div class="mt-3 p-3 bg-slate-900 border border-accent/50 rounded text-center"><div class="text-[10px] text-muted font-mono">AGREED</div><div class="text-xl font-bold text-accent">${w.selectedOption}</div></div>`;
                        } else {
                            const instruction = isTarget ? '<div class="text-[10px] text-accent mb-2 animate-pulse">ACTION: CHOOSE ONE</div>' : '<div class="text-[10px] text-yellow-500 mb-2">WAITING PARTNER...</div>';
                            const btns = w.options.map(o => 
                                `<button ${isTarget ? `onclick="selectOption('${id}', '${o}')"` : 'disabled'} 
                                class="w-full text-left px-4 py-3 text-sm rounded border mb-2 font-mono transition-all
                                ${isTarget ? 'bg-slate-800 hover:border-accent cursor-pointer' : 'bg-slate-900 text-slate-500 cursor-not-allowed'}">
                                [ ] ${o}</button>`
                            ).join('');
                            content = `<div class="mt-3">${instruction}${btns}</div>`;
                        }
                    }

                    let footer = "";
                    if (w.status === 'pending') {
                        if (isCreator) footer = `<div class="text-[10px] text-muted">To: @${w.targetUsername}</div><button onclick="markComplete('${id}')" class="text-xs bg-slate-700 text-white hover:bg-accent hover:text-bg font-bold px-3 py-1.5 rounded">COMPLETE <i class="fas fa-check"></i></button>`;
                        else footer = `<div class="text-[10px] text-muted">From: @${w.creatorUsername}</div><span class="text-[10px] text-yellow-500 font-mono bg-yellow-500/10 px-2 py-1 rounded border border-yellow-500/20">PENDING</span>`;
                    } else {
                        footer = `<div class="text-[10px] text-muted">Done</div><span class="text-xs text-accent font-bold flex items-center gap-1"><i class="fas fa-check-double"></i> CLOSED</span>`;
                    }

                    list.innerHTML += `
                        <div class="bg-card p-5 rounded-xl border ${isTarget && w.status === 'pending' ? 'border-accent shadow-[0_0_10px_rgba(16,185,129,0.2)]' : 'border-slate-700'} fade-in relative group">
                            <div class="flex justify-between items-start mb-2">
                                <div><span class="text-[10px] font-mono uppercase tracking-wider ${w.type === 'direct' ? 'text-blue-400' : 'text-purple-400'}">${w.type === 'direct' ? 'MARKET' : 'LIMIT'}</span><h4 class="font-bold text-white text-lg">${w.title}</h4></div>
                                ${isCreator ? `<button onclick="deleteWager('${id}')" class="text-slate-600 hover:text-danger px-2"><i class="fas fa-times"></i></button>` : ''}
                            </div>
                            ${content}
                            <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-800/50">${footer}</div>
                        </div>`;
                });
                if(!hasData) list.innerHTML = `<div class="text-center py-10 text-muted text-sm font-mono border border-dashed border-slate-800 rounded-lg">NO CONTRACTS</div>`;
            });
        }

        // --- GLOBAL ACTIONS ---
        window.markComplete = (id) => ConfirmModal.fire({title: 'Complete Contract?', icon:'question'}).then(r => { if(r.isConfirmed) updateDoc(doc(db, "wagers", id), {status:'completed'}).then(()=>Toast.fire('Success', 'Contract Closed', 'success')); });
        window.selectOption = (id, opt) => ConfirmModal.fire({title: `Pick "${opt}"?`, icon:'info'}).then(r => { if(r.isConfirmed) updateDoc(doc(db, "wagers", id), {selectedOption:opt}).then(()=>Toast.fire('Success', 'Option Locked', 'success')); });
        window.deleteWager = (id) => ConfirmModal.fire({title: 'Delete?', icon:'warning'}).then(r => { if(r.isConfirmed) deleteDoc(doc(db, "wagers", id)); });

        // --- FRIEND LOGIC ---
        window.sendFriendRequest = async () => {
            const name = document.getElementById('friendInput').value.trim().toLowerCase();
            if(!name || name === userProfile.username) return Toast.fire({icon:'error', title:'Invalid'});
            const snap = await getDocs(query(collection(db, "users"), where("username", "==", name)));
            if(snap.empty) return Toast.fire({icon:'error', title:'Not Found'});
            const t = snap.docs[0].data();
            await addDoc(collection(db, "friend_requests"), { fromUid: currentUser.uid, fromUsername: userProfile.username, fromPhoto: userProfile.photoURL, toUid: t.uid, status: 'pending' });
            Toast.fire({icon:'success', title:'Request Sent'});
        };
        
        function listenToFriendRequests() {
            onSnapshot(query(collection(db, "friend_requests"), where("toUid", "==", currentUser.uid), where("status", "==", "pending")), (snap) => {
                const l = document.getElementById('requestListDisplay');
                l.innerHTML = "";
                if(!snap.empty) {
                    document.getElementById('reqBadge').classList.remove('hidden');
                    document.getElementById('pendingSection').classList.remove('hidden');
                    snap.forEach(d => {
                        const r = d.data();
                        l.innerHTML += `<div class="bg-slate-800 p-3 rounded-lg flex justify-between items-center"><div class="flex items-center gap-2"><img src="${r.fromPhoto}" class="w-8 h-8 rounded-full"><span class="font-bold text-white">@${r.fromUsername}</span></div><div class="flex gap-1"><button onclick="acceptFriend('${d.id}', '${r.fromUid}', '${r.fromUsername}', '${r.fromPhoto}')" class="bg-accent text-bg px-2 py-1 rounded text-xs font-bold">ACC</button><button onclick="rejectFriend('${d.id}')" class="bg-slate-700 text-white px-2 py-1 rounded text-xs">REJ</button></div></div>`;
                    });
                }
            });
        }

        window.acceptFriend = async (id, uid, name, photo) => {
            const b = writeBatch(db);
            b.update(doc(db, "users", currentUser.uid), { friends: arrayUnion({uid, username:name, photoURL:photo}) });
            b.update(doc(db, "users", uid), { friends: arrayUnion({uid:currentUser.uid, username:userProfile.username, photoURL:userProfile.photoURL}) });
            b.delete(doc(db, "friend_requests", id));
            await b.commit();
            Toast.fire({icon:'success', title:'Friend Added'});
        };
        window.rejectFriend = (id) => deleteDoc(doc(db, "friend_requests", id));

        // --- UNFOLLOW FEATURE ---
        window.unfollowFriend = async (friendUid) => {
            ConfirmModal.fire({title: 'Unfollow?', text: 'Chat & Wager access will be revoked.', icon: 'warning'}).then(async (r) => {
                if(r.isConfirmed) {
                    const b = writeBatch(db);
                    // Filter array lokal untuk remove
                    const myNewFriends = userProfile.friends.filter(f => f.uid !== friendUid);
                    b.update(doc(db, "users", currentUser.uid), { friends: myNewFriends });
                    
                    // Kita harus ambil data teman untuk remove diri kita dari list dia
                    const friendSnap = await getDoc(doc(db, "users", friendUid));
                    if(friendSnap.exists()) {
                        const friendData = friendSnap.data();
                        const friendNewFriends = friendData.friends.filter(f => f.uid !== currentUser.uid);
                        b.update(doc(db, "users", friendUid), { friends: friendNewFriends });
                    }
                    await b.commit();
                    Toast.fire({icon: 'success', title: 'User Unfollowed'});
                }
            });
        };

        function renderFriendListNetwork() {
            const l = document.getElementById('myFriendList');
            l.innerHTML = "";
            userProfile.friends?.forEach(f => {
                l.innerHTML += `
                    <div class="flex justify-between items-center bg-card p-3 rounded-lg border border-slate-700">
                        <div class="flex items-center gap-3">
                            <img src="${f.photoURL}" class="w-8 h-8 rounded-full">
                            <span class="font-bold text-white">@${f.username}</span>
                        </div>
                        <button onclick="unfollowFriend('${f.uid}')" class="text-slate-600 hover:text-danger px-2 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`;
            });
        }

        // UTILS
        window.saveUsername = async () => {
            const u = document.getElementById('newUsernameInput').value.trim().toLowerCase();
            if(u.length < 3) return Toast.fire({icon:'error', title:'Min 3 chars'});
            await setDoc(doc(db, "users", currentUser.uid), { uid: currentUser.uid, email: currentUser.email, photoURL: currentUser.photoURL, username: u, friends: [], createdAt: new Date(), status: 'online' });
            document.getElementById('usernameModal').classList.add('hidden');
        };
        function renderNavbar() {
            document.getElementById('navProfile').innerHTML = `<div class="text-right hidden sm:block"><div class="text-xs font-bold text-white">@${userProfile.username}</div></div><img src="${userProfile.photoURL}" class="w-8 h-8 rounded-full border border-slate-600"><button onclick="logout()" class="text-slate-400 ml-2"><i class="fas fa-sign-out-alt"></i></button>`;
        }
        function loadFriendsDropdown() {
            const s = document.getElementById('targetUserSelect');
            s.innerHTML = '<option value="" disabled selected>Select friend...</option>';
            userProfile.friends?.forEach(f => s.innerHTML += `<option value="${f.uid}">@${f.username}</option>`);
        }

        window.switchTab = (t) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-accent'));
            document.getElementById(`tab-${t}`).classList.add('active');
            ['home', 'chat', 'network'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${t}`).classList.remove('hidden');
        };
        window.toggleType = (t) => {
            currentType = t;
            document.getElementById('btnDirect').className = t === 'direct' ? "px-3 py-1 text-[10px] font-bold rounded bg-slate-700 text-white" : "px-3 py-1 text-[10px] font-bold rounded text-muted";
            document.getElementById('btnChoice').className = t === 'choice' ? "px-3 py-1 text-[10px] font-bold rounded bg-slate-700 text-white" : "px-3 py-1 text-[10px] font-bold rounded text-muted";
            document.getElementById(t === 'direct' ? 'inputDirect' : 'inputChoice').classList.remove('hidden');
            document.getElementById(t === 'direct' ? 'inputChoice' : 'inputDirect').classList.add('hidden');
        };

        // EXPORT
        window.acceptFriend = acceptFriend;
        window.rejectFriend = rejectFriend;
        window.selectOption = selectOption;
        window.markComplete = markComplete;
        window.deleteWager = deleteWager;
        window.unfollowFriend = unfollowFriend;
    </script>
</body>
</html>
