<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wager Protocol - Secure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['Space Mono', 'monospace'], },
                    colors: { bg: '#0B1120', card: '#151F32', accent: '#10B981', danger: '#EF4444', muted: '#64748B' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0B1120; color: #E2E8F0; }
        .input-dark { background: #0F172A; border: 1px solid #334155; color: #E2E8F0; }
        .input-dark:focus { border-color: #10B981; outline: none; }
        /* Animasi */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen pb-10 relative overflow-x-hidden">

    <div id="loginOverlay" class="fixed inset-0 z-[100] bg-[#0B1120] flex flex-col items-center justify-center p-6 hidden">
        <div class="text-center mb-10">
            <div class="w-16 h-16 bg-accent/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-accent/50 shadow-[0_0_15px_rgba(16,185,129,0.3)]">
                <i class="fas fa-fingerprint text-2xl text-accent"></i>
            </div>
            <h2 class="text-2xl font-bold tracking-tight text-white">IDENTIFY YOURSELF</h2>
            <p class="text-muted text-sm font-mono mt-2">Who is accessing the terminal?</p>
        </div>
        
        <div class="space-y-4 w-full max-w-xs">
            <button onclick="setIdentity('Player 1')" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-accent text-white py-4 rounded-xl transition-all group relative overflow-hidden">
                <div class="absolute inset-0 w-1 bg-accent transition-all group-hover:w-full opacity-10"></div>
                <span class="font-bold relative z-10">PLAYER 1 (Cowok)</span>
            </button>
            <button onclick="setIdentity('Player 2')" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-pink-500 text-white py-4 rounded-xl transition-all group relative overflow-hidden">
                <div class="absolute inset-0 w-1 bg-pink-500 transition-all group-hover:w-full opacity-10"></div>
                <span class="font-bold relative z-10">PLAYER 2 (Cewek)</span>
            </button>
        </div>
    </div>

    <nav class="border-b border-slate-800 bg-bg/90 backdrop-blur-md sticky top-0 z-40">
        <div class="max-w-xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-accent animate-pulse"></div>
                <h1 class="font-bold text-sm tracking-widest">WAGER<span class="text-accent">NET</span></h1>
            </div>
            <div class="flex items-center gap-3">
                <span id="userDisplay" class="text-[10px] font-mono bg-slate-800 px-2 py-1 rounded text-accent border border-slate-700">GUEST</span>
                <button onclick="logout()" class="text-slate-500 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <div class="max-w-xl mx-auto px-4 mt-6">
        
        <div class="bg-card rounded-xl border border-slate-700 shadow-xl overflow-hidden mb-8">
            <div class="p-3 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
                <h2 class="font-mono text-xs text-accent">CREATE NEW CONTRACT</h2>
                <div class="flex bg-slate-900 rounded p-1 border border-slate-800">
                    <button id="btnDirect" class="px-3 py-1 text-[10px] font-bold rounded bg-slate-700 text-white" onclick="toggleType('direct')">DIRECT</button>
                    <button id="btnChoice" class="px-3 py-1 text-[10px] font-bold rounded text-muted" onclick="toggleType('choice')">CHOICE</button>
                </div>
            </div>

            <form id="wagerForm" onsubmit="submitWager(event)" class="p-5">
                <div class="mb-4">
                    <input type="text" id="title" placeholder="Context (e.g. Mobile Legends Match)" class="w-full input-dark rounded-lg px-4 py-3 text-sm font-bold" required>
                </div>

                <div id="inputDirect" class="mb-4">
                    <textarea id="directRequest" rows="2" placeholder="Input Demand..." class="w-full input-dark rounded-lg px-4 py-3 text-sm font-mono"></textarea>
                </div>

                <div id="inputChoice" class="mb-4 hidden">
                    <textarea id="choiceOptions" rows="2" placeholder="Option A, Option B, Option C" class="w-full input-dark rounded-lg px-4 py-3 text-sm font-mono"></textarea>
                    <p class="text-[10px] text-muted mt-2">Partner will choose one.</p>
                </div>

                <button type="submit" class="w-full bg-accent hover:bg-emerald-400 text-bg font-bold py-3 rounded-lg text-sm uppercase tracking-widest shadow-[0_0_15px_rgba(16,185,129,0.4)] transition-all">
                    Initiate Protocol
                </button>
            </form>
        </div>

        <div id="wagerList" class="space-y-4 pb-20">
            </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- GANTI CONFIG DI SINI ---
	const firebaseConfig = {
  		apiKey: "AIzaSyDTLkvNNwh4LoJuLW1JhsF1S_ZOY1k-PAM",
  		authDomain: "webchoice-9b2c0.firebaseapp.com",
  		projectId: "webchoice-9b2c0",
  		storageBucket: "webchoice-9b2c0.firebasestorage.app",
  		messagingSenderId: "754013239435",
  		appId: "1:754013239435:web:496f9a5851d0586ee43c8e"
	};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const wagersRef = collection(db, "wagers");

        let currentUser = localStorage.getItem('wagerUser');
        let currentType = 'direct';

        // --- AUTH LOGIC ---
        function checkAuth() {
            const overlay = document.getElementById('loginOverlay');
            if (!currentUser) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
                document.getElementById('userDisplay').innerText = currentUser.toUpperCase();
            }
        }
        
        window.setIdentity = (role) => {
            localStorage.setItem('wagerUser', role);
            currentUser = role;
            checkAuth();
            location.reload(); // Reload untuk refresh query kalau perlu
        }

        window.logout = () => {
            localStorage.removeItem('wagerUser');
            location.reload();
        }

        // Jalankan check saat load
        checkAuth();

        // --- UI FORM LOGIC ---
        window.toggleType = (type) => {
            currentType = type;
            document.getElementById('btnDirect').className = type === 'direct' ? "px-3 py-1 text-[10px] font-bold rounded bg-slate-700 text-white" : "px-3 py-1 text-[10px] font-bold rounded text-muted";
            document.getElementById('btnChoice').className = type === 'choice' ? "px-3 py-1 text-[10px] font-bold rounded bg-slate-700 text-white" : "px-3 py-1 text-[10px] font-bold rounded text-muted";
            
            if(type === 'direct') {
                document.getElementById('inputDirect').classList.remove('hidden');
                document.getElementById('inputChoice').classList.add('hidden');
            } else {
                document.getElementById('inputDirect').classList.add('hidden');
                document.getElementById('inputChoice').classList.remove('hidden');
            }
        }

        // --- SUBMIT DATA (Mencatat siapa pembuatnya) ---
        window.submitWager = async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value;
            
            let data = {
                title: title,
                type: currentType,
                createdBy: currentUser, // PENTING: Simpan siapa yang bikin
                timestamp: new Date(),
                status: 'pending'
            };

            if (currentType === 'direct') {
                data.content = document.getElementById('directRequest').value;
                if(!data.content) return alert("Empty demand.");
            } else {
                const rawOptions = document.getElementById('choiceOptions').value;
                if(!rawOptions) return alert("Options required.");
                data.options = rawOptions.split(',').map(opt => opt.trim()).filter(opt => opt !== "");
                data.selectedOption = null;
            }

            try {
                await addDoc(wagersRef, data);
                document.getElementById('wagerForm').reset();
            } catch (error) {
                console.error("Error", error);
            }
        }

        // --- RENDER LIST (Logika Siapa Melihat Apa) ---
        const q = query(wagersRef, orderBy("timestamp", "desc"));
        
        onSnapshot(q, (snapshot) => {
            const listContainer = document.getElementById('wagerList');
            listContainer.innerHTML = "";

            if (snapshot.empty) {
                listContainer.innerHTML = `<div class="text-center py-10 text-muted text-sm font-mono border border-dashed border-slate-800 rounded-lg">NO ACTIVE CONTRACTS</div>`;
                return;
            }

            snapshot.forEach((docSnap) => {
                const wager = docSnap.data();
                const id = docSnap.id;
                
                // Cek Kepemilikan
                const isMyWager = wager.createdBy === currentUser;
                
                let contentHtml = "";
                let footerHtml = "";

                // --- 1. LOGIKA KONTEN (Pilihan) ---
                if (wager.type === 'direct') {
                    contentHtml = `<div class="text-lg font-bold text-white mt-2">"${wager.content}"</div>`;
                } else {
                    // Jika sudah dipilih opsi
                    if (wager.selectedOption) {
                        contentHtml = `
                            <div class="mt-3 p-3 bg-slate-900 border border-accent/50 rounded-lg text-center">
                                <div class="text-[10px] text-muted font-mono mb-1">AGREED UPON</div>
                                <div class="text-xl font-bold text-accent">${wager.selectedOption}</div>
                            </div>`;
                    } else {
                        // Belum dipilih: Tampilkan tombol
                        // Jika INI PUNYA SAYA (Pembuat) -> Saya cuma bisa lihat (disabled)
                        // Jika INI DARI LAWAN -> Saya bisa klik
                        const isDisabled = isMyWager ? "disabled opacity-50 cursor-not-allowed" : "";
                        const clickAction = isMyWager ? "" : `onclick="selectOption('${id}', 'OPT_VAL')"`;
                        const instruction = isMyWager ? `<div class="text-[10px] text-yellow-500 mb-2 font-mono"><i class="fas fa-clock"></i> WAITING FOR PARTNER TO CHOOSE...</div>` : `<div class="text-[10px] text-accent mb-2 font-mono animate-pulse"><i class="fas fa-exclamation-circle"></i> ACTION REQUIRED: CHOOSE ONE</div>`;

                        let btns = wager.options.map(opt => 
                            `<button ${isMyWager ? '' : `onclick="selectOption('${id}', '${opt}')"`} class="w-full text-left px-4 py-3 text-sm rounded border ${isMyWager ? 'border-slate-800 bg-slate-900 text-slate-500' : 'border-slate-600 bg-slate-800 hover:border-accent hover:bg-slate-700 text-white'} transition-all mb-2 font-mono" ${isDisabled}>
                                [ ] ${opt}
                             </button>`
                        ).join('');
                        contentHtml = `<div class="mt-3">${instruction}${btns}</div>`;
                    }
                }

                // --- 2. LOGIKA TOMBOL SELESAI (Action) ---
                // Hanya PEMBUAT yang bisa menandai "Selesai" (Validasi hadiah diterima)
                if (wager.status === 'pending') {
                    if (isMyWager) {
                        // Saya yang bikin, saya yang bisa mark done
                        footerHtml = `
                            <div class="text-[10px] text-muted">Created by YOU</div>
                            <button onclick="markComplete('${id}')" class="text-xs bg-accent text-bg font-bold px-3 py-1.5 rounded hover:bg-emerald-400 transition-colors">
                                CONFIRM RECEIPT <i class="fas fa-check ml-1"></i>
                            </button>
                        `;
                    } else {
                        // Lawan yang bikin, saya cuma bisa lihat status
                        footerHtml = `
                            <div class="text-[10px] text-muted">Created by ${wager.createdBy}</div>
                            <span class="text-[10px] text-yellow-500 font-mono bg-yellow-500/10 px-2 py-1 rounded border border-yellow-500/20">PENDING EXECUTION</span>
                        `;
                    }
                } else {
                    footerHtml = `
                        <div class="text-[10px] text-muted">Completed</div>
                        <span class="text-xs text-accent font-bold flex items-center gap-1"><i class="fas fa-check-double"></i> TRANSACTION CLOSED</span>
                    `;
                }

                // --- 3. DELETE BUTTON (Hanya Pembuat) ---
                const deleteBtn = isMyWager ? `<button onclick="deleteWager('${id}')" class="text-slate-600 hover:text-danger px-2"><i class="fas fa-times"></i></button>` : '';

                // RENDER CARD
                const cardHtml = `
                    <div class="bg-card p-5 rounded-xl border ${isMyWager ? 'border-slate-700' : 'border-accent/30 shadow-[0_0_10px_rgba(16,185,129,0.1)]'} fade-in relative group">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-[10px] font-mono uppercase tracking-wider ${wager.type === 'direct' ? 'text-blue-400' : 'text-purple-400'}">
                                    ${wager.type === 'direct' ? 'MARKET ORDER' : 'LIMIT ORDER'}
                                </span>
                                <h4 class="font-bold text-white text-lg">${wager.title}</h4>
                            </div>
                            ${deleteBtn}
                        </div>
                        
                        ${contentHtml}

                        <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-800/50">
                            ${footerHtml}
                        </div>
                    </div>
                `;
                
                listContainer.innerHTML += cardHtml;
            });
        });

        // --- DATABASE ACTIONS ---
        window.markComplete = async (id) => {
            if(confirm("Confirm that reward has been received?")) {
                await updateDoc(doc(db, "wagers", id), { status: 'completed' });
            }
        }

        window.selectOption = async (id, option) => {
            // Langsung update database, karena yang klik pasti pihak "Penerima" (Logic di render sudah handle ini)
            if(confirm(`Lock in option: "${option}"?`)) {
                await updateDoc(doc(db, "wagers", id), { selectedOption: option });
            }
        }

        window.deleteWager = async (id) => {
            if(confirm("Terminate this contract?")) {
                await deleteDoc(doc(db, "wagers", id));
            }
        }

    </script>
</body>
</html>
